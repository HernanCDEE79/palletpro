<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PalletPRO">
    <meta name="theme-color" content="#0F172A">
    <title>PalletPRO</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --safety-orange: #FF8C00;
            --danger-red: #E11D48;
            --apple-green: #22C55E;
            --navy: #0F172A;
            --accent: #FF8C00;
        }
        * { -webkit-tap-highlight-color: transparent; }
        body {
            background: #F1F5F9;
            font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
            touch-action: pan-y;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
        }
        /* Buttons */
        .btn-primary { background: var(--navy); color: white; padding: 16px; border-radius: 10px; font-weight: 900; width: 100%; font-size: 15px; letter-spacing: 0.5px; transition: all 0.15s; border-bottom: 4px solid #060E1C; }
        .btn-danger { background: var(--danger-red); color: white; padding: 16px; border-radius: 10px; font-weight: 900; width: 100%; font-size: 15px; border-bottom: 4px solid #9F0F2F; transition: all 0.15s; }
        .btn-success { background: var(--apple-green); color: white; padding: 16px; border-radius: 10px; font-weight: 900; width: 100%; font-size: 15px; border-bottom: 4px solid #157A37; transition: all 0.15s; }
        .btn-orange { background: var(--safety-orange); color: white; padding: 16px; border-radius: 10px; font-weight: 900; width: 100%; font-size: 15px; border-bottom: 4px solid #CC6600; transition: all 0.15s; }
        .btn-primary:active, .btn-danger:active, .btn-success:active, .btn-orange:active { transform: translateY(2px); border-bottom-width: 2px; }
        /* Cards */
        .card { background: white; border-radius: 14px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 14px; }
        .card-danger { background: white; border-radius: 14px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 14px; border-top: 4px solid var(--danger-red); }
        .card-success { background: white; border-radius: 14px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 14px; border-top: 4px solid var(--apple-green); }
        /* Inputs */
        .input-field {
            width: 100%; border: 2px solid #CBD5E0; padding: 13px 14px;
            border-radius: 10px; font-weight: 600; font-size: 16px;
            background: white; color: #1E293B; transition: border-color 0.2s;
            -webkit-appearance: none; appearance: none;
        }
        .input-field:focus { border-color: var(--safety-orange); outline: none; }
        .label { font-size: 11px; font-weight: 800; color: #64748B; text-transform: uppercase; margin-bottom: 6px; display: block; letter-spacing: 0.5px; }
        /* Header */
        .header-top { background: var(--navy); color: white; padding: 14px 16px; }
        /* Nav */
        .nav-btn { flex: 1; padding: 11px 4px; font-size: 9.5px; font-weight: 900; border-bottom: 4px solid transparent; color: #64748B; text-transform: uppercase; letter-spacing: 0.3px; }
        .nav-btn.active { border-bottom-color: var(--safety-orange); color: var(--navy); background: #FAFAFA; }
        .nav-btn i { display: block; font-size: 18px; margin-bottom: 3px; }
        /* Badges */
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; display: inline-block; }
        .badge-red { background: #FEE2E2; color: #991B1B; }
        .badge-green { background: #D1FAE5; color: #065F46; }
        .badge-orange { background: #FFEDD5; color: #9A3412; }
        /* Overlays */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .success-icon { background: white; padding: 28px; border-radius: 50%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); margin-bottom: 20px; }
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.93) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .slide-up { animation: slideUp 0.25s ease-out; }
        /* Photo */
        .photo-preview { height: 110px; background-size: contain; background-position: center; background-repeat: no-repeat; border: 2px solid #22C55E; border-radius: 10px; position: relative; background-color: #F8FAFC; cursor: pointer; }
        .photo-preview::after { content: '‚úì FOTO CARGADA'; position: absolute; bottom: 6px; right: 6px; background: rgba(34,197,94,0.92); color: white; padding: 3px 8px; border-radius: 20px; font-size: 9px; font-weight: 800; }
        .photo-delete-btn { position: absolute; top: 6px; right: 6px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 6px; padding: 4px 8px; font-size: 9px; font-weight: 800; cursor: pointer; z-index: 10; }
        .photo-delete-btn:active { background: rgba(185,28,28,1); transform: scale(0.95); }
        /* Helmet logout button */
        .btn-helmet { 
            background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%); 
            border: 2px solid #FCA5A5; 
            border-radius: 10px; 
            padding: 6px 12px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 11px; 
            font-weight: 900; 
            color: white; 
            letter-spacing: 0.5px; 
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }
        .btn-helmet:active { background: linear-gradient(135deg, #991B1B 0%, #7F1D1D 100%); transform: scale(0.96); }
        .btn-helmet svg { filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
        /* Connection status */
        .connection-status { 
            background: rgba(255,255,255,0.15); 
            border-radius: 8px; 
            padding: 4px 10px; 
            font-size: 9px; 
            font-weight: 900; 
            display: flex; 
            align-items: center; 
            gap: 5px;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
        }
        .connection-status.connected { border-color: #22C55E; background: rgba(34,197,94,0.2); }
        .connection-status.disconnected { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; }
        .status-dot.on { background: #22C55E; animation: pulse 2s infinite; }
        .status-dot.off { background: #CBD5E0; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .chart-container { position: relative; height: 280px; }
        input[type="file"] { display: none; }
        .camera-btn {
            width: 100%; padding: 14px 16px; border: 3px dashed #CBD5E0;
            border-radius: 12px; text-align: center; font-weight: 700;
            color: #64748B; background: #F8FAFC; cursor: pointer; transition: all 0.2s; display: block;
        }
        .camera-btn:active { background: #E2E8F0; transform: scale(0.98); border-color: var(--safety-orange); }
        .camera-btn i { font-size: 22px; display: block; margin-bottom: 4px; color: #94A3B8; }
        /* KPI Cards */
        .kpi-card { border-radius: 14px; padding: 18px; text-align: center; }
        .kpi-value { font-size: 2.8em; font-weight: 900; line-height: 1; }
        .kpi-label { font-size: 0.75em; font-weight: 700; opacity: 0.85; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        /* Loader */
        .loader-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.8); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,140,0,0.2); border-top-color: var(--safety-orange); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* "Otro" fields */
        .otro-field { background: #FFF7ED; border: 2px solid var(--safety-orange) !important; border-radius: 10px; }
        /* Historial card */
        .hist-card { background: white; border-radius: 12px; padding: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 10px; border-left: 5px solid; }
        .hist-card.abierto { border-left-color: var(--danger-red); }
        .hist-card.cerrado { border-left-color: var(--apple-green); }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E0; border-radius: 4px; }
        /* Drive info box */
        .drive-info { background: #EFF6FF; border: 2px solid #BFDBFE; border-radius: 10px; padding: 12px; font-size: 12px; color: #1E40AF; font-weight: 600; }
        .drive-info i { color: #3B82F6; }
        /* Alert box */
        .alert-info { background: #F0FDF4; border: 2px solid #BBF7D0; border-radius: 10px; padding: 12px; font-size: 12px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="loader" class="loader-overlay" style="display: none;">
        <div class="loader-spinner mb-5"></div>
        <p id="loader-text" class="text-white font-black uppercase tracking-wider text-sm"></p>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="login-screen" class="overlay" style="z-index: 150;">
        <div class="card max-w-sm w-full mx-4 fade-in" style="max-height: 90vh; overflow-y: auto;">
            <div class="text-center mb-6">
                <div style="font-size: 64px; line-height: 1;" class="mb-3">üì¶</div>
                <h1 class="text-3xl font-black text-slate-800 mb-1">PalletPRO</h1>
                <div class="text-xs font-black text-orange-500 uppercase tracking-widest mb-1">V4.1</div>
                <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Gesti√≥n de Desv√≠os ¬∑ CD Esteban Echeverr√≠a</p>
            </div>
            <div class="mb-4">
                <label class="label">Seleccione Usuario</label>
                <select id="login-user" class="input-field">
                    <option value="">‚Äî Seleccionar Usuario ‚Äî</option>
                </select>
            </div>
            <div class="mb-5">
                <label class="label">PIN de Acceso</label>
                <input type="password" id="login-pin" class="input-field text-center text-2xl tracking-widest" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric">
            </div>
            <button onclick="appLogin()" class="btn-orange">INGRESAR <i class="fa-solid fa-arrow-right ml-2"></i></button>
            <p id="login-error" class="text-red-500 text-center text-sm font-bold mt-3" style="display:none;">‚ùå Usuario o PIN incorrecto</p>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUCCESS OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="success-overlay" class="overlay" style="display: none; z-index: 160;">
        <div class="text-center fade-in">
            <div class="success-icon">
                <i class="fa-solid fa-check text-green-500 text-6xl"></i>
            </div>
            <h2 class="text-3xl font-black text-white mb-2">¬°GUARDADO!</h2>
            <p class="text-slate-300 text-base font-semibold" id="success-msg">Desv√≠o registrado correctamente</p>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS LOGIN MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="stats-login" class="overlay" style="display: none; z-index: 140;">
        <div class="card max-w-sm w-full mx-4 fade-in">
            <div class="text-center mb-5">
                <i class="fa-solid fa-chart-line text-4xl text-orange-500 mb-3"></i>
                <h2 class="text-xl font-black text-slate-800">Acceso Restringido</h2>
                <p class="text-sm text-slate-500 mt-1">Solo supervisores y administradores</p>
            </div>
            <div class="mb-4">
                <label class="label">Seleccione Usuario</label>
                <select id="stats-user" class="input-field">
                    <option value="">‚Äî Seleccionar ‚Äî</option>
                </select>
            </div>
            <div class="mb-5">
                <label class="label">PIN de Acceso</label>
                <input type="password" id="stats-pin" class="input-field text-center text-2xl tracking-widest" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric">
            </div>
            <p id="stats-error" class="text-red-500 text-center text-sm font-bold mb-3" style="display:none;">‚ùå PIN incorrecto o no autorizado</p>
            <div class="flex gap-3">
                <button onclick="closeStatsLogin()" class="btn-primary flex-1" style="font-size: 13px; padding: 14px;">CANCELAR</button>
                <button onclick="verifyStatsAccess()" class="btn-orange flex-1" style="font-size: 13px; padding: 14px;">ACCEDER</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PHOTO VIEWER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="photo-viewer" class="overlay" style="display: none; z-index: 170;">
        <div style="max-width: 95vw; max-height: 90vh; display: flex; flex-direction: column; align-items: center;">
            <img id="photo-viewer-img" src="" style="max-width: 100%; max-height: 75vh; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <button onclick="document.getElementById('photo-viewer').style.display='none'" class="btn-primary mt-4" style="width: 200px; padding: 14px;">CERRAR</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDIT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="edit-modal" class="overlay" style="display: none; z-index: 180;">
        <div style="background: white; border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%); color: white; padding: 16px; border-radius: 8px; margin: -24px -24px 20px -24px;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 900;">‚úèÔ∏è EDITAR DESV√çO</h2>
                <p id="edit-modal-title" style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9; font-weight: 600;"></p>
            </div>
            
            <div id="edit-desvio-id" style="display: none;"></div>
            
            <div class="mb-3">
                <label class="label">Nave</label>
                <select id="edit-nave" class="input-field">
                    <option value="A">Nave A</option>
                    <option value="B">Nave B</option>
                    <option value="C">Nave C</option>
                    <option value="D">Nave D</option>
                    <option value="D-S">Nave D-S</option>
                    <option value="E">Nave E</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="label">Calle/Canal</label>
                <input type="text" id="edit-calle" class="input-field" placeholder="Ej: 15">
            </div>
            
            <div class="mb-3">
                <label class="label">Posici√≥n</label>
                <input type="text" id="edit-posicion" class="input-field" placeholder="Ej: 120">
            </div>
            
            <div class="mb-3">
                <label class="label">Nivel</label>
                <input type="text" id="edit-nivel" class="input-field" placeholder="Ej: 3">
            </div>
            
            <div class="mb-3">
                <label class="label">Estado del Pallet</label>
                <select id="edit-estado" class="input-field" onchange="document.getElementById('edit-estado-otro-box').style.display = this.value === 'OTRO' ? 'block' : 'none'">
                    <option value="FILM ROTO">FILM ROTO</option>
                    <option value="PALLET ROTO">PALLET ROTO</option>
                    <option value="PALLET MONTADO ROTO">PALLET MONTADO ROTO</option>
                    <option value="PALLET MAL ESTIBADO">PALLET MAL ESTIBADO</option>
                    <option value="OTRO">OTRO</option>
                </select>
            </div>

            <div id="edit-estado-otro-box" style="display:none;" class="mb-3">
                <input type="text" id="edit-estado-otro" class="input-field" placeholder="Especificar estado">
            </div>
            
            <div class="mb-3">
                <label class="label">Detectado Por</label>
                <select id="edit-detectado" class="input-field" onchange="document.getElementById('edit-detectado-otro-box').style.display = this.value === 'OTRO' ? 'block' : 'none'">
                    <option value="RECEPCI√ìN">RECEPCI√ìN</option>
                    <option value="PREPARACI√ìN">PREPARACI√ìN</option>
                    <option value="EXPEDICI√ìN">EXPEDICI√ìN</option>
                    <option value="HIGIENE Y SEGURIDAD">HIGIENE Y SEGURIDAD</option>
                    <option value="OTRO">OTRO</option>
                </select>
            </div>

            <div id="edit-detectado-otro-box" style="display:none;" class="mb-3">
                <input type="text" id="edit-detectado-otro" class="input-field" placeholder="Especificar qui√©n detect√≥">
            </div>
            
            <div class="flex gap-2 mt-4">
                <button onclick="cerrarModalEditar()" class="flex-1 bg-slate-300 text-slate-700 px-4 py-3 rounded-lg font-bold">
                    CANCELAR
                </button>
                <button onclick="guardarEdicion()" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-bold">
                    üíæ GUARDAR
                </button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <header class="header-top flex-shrink-0">
        <div class="flex justify-between items-center">
            <div>
                <div class="text-xs font-black text-orange-400 tracking-wider">CD ESTEBAN ECHEVERR√çA</div>
                <div class="text-sm font-black text-white" id="current-date">--/--/----</div>
                <div class="text-xs text-slate-400 font-semibold mt-0.5" id="user-display">‚Äî</div>
            </div>
            <div class="text-right">
                <div class="text-xl font-black text-orange-400 font-mono mb-1" id="current-time">--:--</div>
                <div class="flex items-center gap-2 justify-end">
                    <button onclick="recargarDesdeSheets()" class="bg-blue-500 text-white rounded-lg px-2 py-1 font-black text-xs flex items-center gap-1" style="font-size: 9px;">
                        <i class="fa-solid fa-rotate"></i> ACTUALIZAR
                    </button>
                    <div id="sheets-status" class="connection-status disconnected" title="Google Sheets">
                        <div class="status-dot off"></div>
                        <span style="font-size: 7px;">SHEETS</span>
                    </div>
                    <div id="drive-status" class="connection-status disconnected" title="Google Drive">
                        <div class="status-dot off"></div>
                        <span style="font-size: 7px;">DRIVE</span>
                    </div>
                    <button onclick="logout()" class="btn-helmet">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 512 512" fill="currentColor">
                            <path d="M256 48c-79.5 0-144 64.5-144 144s64.5 144 144 144 144-64.5 144-144S335.5 48 256 48zm0 240c-53 0-96-43-96-96s43-96 96-96 96 43 96 96-43 96-96 96z"/>
                            <path d="M256 0C158.8 0 80 78.8 80 176c0 44.4 16.5 84.9 43.6 115.8L96 464h64l-16-96h224l-16 96h64l-27.6-172.2C415.5 260.9 432 220.4 432 176 432 78.8 353.2 0 256 0zm0 304c-70.7 0-128-57.3-128-128S185.3 48 256 48s128 57.3 128 128-57.3 128-128 128z"/>
                            <rect x="208" y="464" width="96" height="48" rx="8"/>
                        </svg>
                        SALIR
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <nav class="flex bg-white border-b-2 border-slate-100 shadow-sm flex-shrink-0">
        <button onclick="showTab('nuevo')" id="tab-btn-nuevo" class="nav-btn active">
            <i class="fa-solid fa-plus-circle"></i>NUEVO
        </button>
        <button onclick="showTab('cerrar')" id="tab-btn-cerrar" class="nav-btn">
            <i class="fa-solid fa-lock"></i>CERRAR
        </button>
        <button onclick="showTab('historial')" id="tab-btn-historial" class="nav-btn">
            <i class="fa-solid fa-clock-rotate-left"></i>HISTORIAL
        </button>
        <button onclick="requestStatsAccess()" id="tab-btn-stats" class="nav-btn">
            <i class="fa-solid fa-chart-line"></i>STATS
        </button>
    </nav>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <main class="flex-1 overflow-y-auto" style="padding: 16px; padding-bottom: 24px;">

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB: NUEVO DESV√çO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <section id="content-nuevo">
            <div class="card-danger">
                <div class="flex items-center gap-3 mb-5">
                    <div style="background: var(--danger-red); padding: 10px; border-radius: 10px;">
                        <i class="fa-solid fa-triangle-exclamation text-white text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-black text-slate-800">‚ö†Ô∏è NUEVO DESV√çO</h2>
                        <p class="text-xs text-slate-400 font-semibold">üì¶ Registrar pallet en mal estado</p>
                    </div>
                </div>

                <!-- Nave + Turno -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="label"><i class="fa-solid fa-warehouse mr-1"></i> Nave</label>
                        <select id="n-nave" class="input-field" onchange="checkOtro('n-nave', 'n-nave-otro-box')">
                            <option value="A">NAVE A</option>
                            <option value="B">NAVE B</option>
                            <option value="C">NAVE C</option>
                            <option value="D">NAVE D</option>
                            <option value="D-S">NAVE D-S</option>
                            <option value="E">NAVE E</option>
                            <option value="OTRO">OTRO</option>
                        </select>
                    </div>
                    <div>
                        <label class="label"><i class="fa-regular fa-clock mr-1"></i> Turno</label>
                        <select id="n-turno" class="input-field">
                            <option value="MA√ëANA">MA√ëANA</option>
                            <option value="TARDE">TARDE</option>
                            <option value="NOCHE">NOCHE</option>
                        </select>
                    </div>
                </div>
                <!-- Nave OTRO -->
                <div id="n-nave-otro-box" class="mb-4" style="display:none;">
                    <label class="label" style="color: var(--safety-orange);">Especificar Nave</label>
                    <input type="text" id="n-nave-otro" class="input-field otro-field" placeholder="Escriba la nave..." style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase()">
                </div>

                <!-- Calle / Posici√≥n / Nivel -->
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div>
                        <label class="label">Calle</label>
                        <input type="number" id="n-calle" class="input-field" placeholder="Ej: 15" min="1">
                    </div>
                    <div>
                        <label class="label">Posici√≥n</label>
                        <input type="number" id="n-posicion" class="input-field" placeholder="Ej: 120" min="1">
                    </div>
                    <div>
                        <label class="label">Nivel</label>
                        <input type="number" id="n-nivel" class="input-field" placeholder="Ej: 3" min="1">
                    </div>
                </div>

                <!-- Estado del Pallet -->
                <div class="mb-4">
                    <label class="label"><i class="fa-solid fa-pallet mr-1"></i> Estado del Pallet</label>
                    <select id="n-estado" class="input-field" onchange="checkOtro('n-estado', 'n-estado-otro-box')">
                        <option value="FILM ROTO">FILM ROTO</option>
                        <option value="PALLET ROTO">PALLET ROTO</option>
                        <option value="PALLET MONTADO ROTO">PALLET MONTADO ROTO</option>
                        <option value="PALLET MAL ESTIBADO">PALLET MAL ESTIBADO</option>
                        <option value="OTRO">OTRO (ESPECIFICAR)</option>
                    </select>
                </div>
                <!-- Estado OTRO -->
                <div id="n-estado-otro-box" class="mb-4" style="display:none;">
                    <label class="label" style="color: var(--safety-orange);">Especificar Estado</label>
                    <input type="text" id="n-estado-otro" class="input-field otro-field" placeholder="Describa el estado del pallet..." style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase()">
                </div>

                <!-- Detectado Por -->
                <div class="mb-4">
                    <label class="label"><i class="fa-solid fa-magnifying-glass mr-1"></i> Detectado Por</label>
                    <select id="n-detectado" class="input-field" onchange="checkOtro('n-detectado', 'n-detectado-otro-box')">
                        <option value="RECEPCI√ìN">RECEPCI√ìN</option>
                        <option value="PREPARACI√ìN">PREPARACI√ìN</option>
                        <option value="EXPEDICI√ìN">EXPEDICI√ìN</option>
                        <option value="HIGIENE Y SEGURIDAD">HIGIENE Y SEGURIDAD</option>
                        <option value="OTRO">OTRO (ESPECIFICAR)</option>
                    </select>
                </div>
                <!-- Detectado OTRO -->
                <div id="n-detectado-otro-box" class="mb-4" style="display:none;">
                    <label class="label" style="color: var(--safety-orange);">Especificar Sector</label>
                    <input type="text" id="n-detectado-otro" class="input-field otro-field" placeholder="Escriba el sector..." style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase()">
                </div>

                <!-- Foto -->
                <div class="mb-5">
                    <label class="label"><i class="fa-solid fa-camera mr-1"></i> Fotograf√≠a del Desv√≠o <span class="text-red-500">*</span></label>
                             <input type="file" id="n-foto" accept="image/*" capture="environment" onchange="recibirFoto('n-foto','n-foto-preview','n-foto-btn',true)" style="display:none">
                    <input type="file" id="n-foto-galeria" accept="image/*" onchange="recibirFoto('n-foto-galeria','n-foto-preview','n-foto-btn',true)" style="display:none">
                    <button type="button" id="n-foto-btn" class="camera-btn" onclick="abrirModalFoto('n-foto','n-foto-galeria','n-foto-preview','n-foto-btn')">
                        <i class="fa-solid fa-camera"></i>
                        TOMAR FOTO / GALER√çA
                    </button>
                    <div id="n-foto-preview" class="photo-preview mt-3" style="display: none;" onclick="enlargePhoto('n-foto')">
                        <button onclick="deletePhoto(event, 'n-foto', 'n-foto-preview', 'n-foto-btn')" class="photo-delete-btn">üóëÔ∏è BORRAR</button>
                    </div>
                </div>

                <!-- Drive Info -->
                <div class="drive-info mb-4">
                    <i class="fa-brands fa-google-drive mr-2"></i>
                    La foto se guardar√° en <strong>Drive</strong> con nombre: <em>NAVE-CALLE-POS-NIV_FECHA.jpg</em> dentro de la carpeta de la nave correspondiente.
                </div>

                <button onclick="guardarNuevoDesvio()" class="btn-danger">
                    <i class="fa-solid fa-triangle-exclamation mr-2"></i> GENERAR DESV√çO
                </button>
            </div>
        </section>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB: CERRAR DESV√çO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <section id="content-cerrar" style="display: none;">
            <div class="card-success">
                <div class="flex items-center gap-3 mb-5">
                    <div style="background: var(--apple-green); padding: 10px; border-radius: 10px;">
                        <i class="fa-solid fa-check text-white text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-black text-slate-800">‚úÖ CERRAR DESV√çO</h2>
                        <p class="text-xs text-slate-400 font-semibold">üîß Registrar correcci√≥n de pallet</p>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="label">Seleccionar Desv√≠o Pendiente</label>
                    <select id="c-desvio" class="input-field" onchange="mostrarInfoDesvio()">
                        <option value="">‚Äî Seleccione un desv√≠o ‚Äî</option>
                    </select>
                </div>

                <!-- Bot√≥n Editar -->
                <div class="mb-4">
                    <button onclick="editarDesvio()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2 border-b-4 border-blue-800">
                        <i class="fa-solid fa-pen-to-square"></i> EDITAR DESV√çO
                    </button>
                </div>

                <div id="c-info-container" style="display: none;" class="slide-up">
                    <div id="c-info" class="bg-red-50 border-l-4 border-red-500 p-4 mb-4 rounded-xl text-sm font-semibold text-slate-700"></div>

                    <!-- Usuario que cierra -->
                    <div class="mb-4">
                        <label class="label"><i class="fa-solid fa-user-check mr-1"></i> Usuario que Cierra</label>
                        <select id="c-usuario-cierra" class="input-field">
                            <option value="">‚Äî Seleccionar ‚Äî</option>
                        </select>
                    </div>

                    <!-- PIN confirmaci√≥n -->
                    <div class="mb-4">
                        <label class="label"><i class="fa-solid fa-key mr-1"></i> PIN Confirmaci√≥n</label>
                        <input type="password" id="c-pin-cierra" class="input-field text-center text-xl tracking-widest" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric">
                    </div>

                    <!-- Cliente / Proveedor -->
                    <div class="mb-4">
                        <label class="label"><i class="fa-solid fa-building mr-1"></i> Cliente / Proveedor</label>
                        <input type="text" id="c-cliente" class="input-field" placeholder="Nombre del cliente/proveedor" style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <!-- Corregido Por -->
                    <div class="mb-4">
                        <label class="label"><i class="fa-solid fa-wrench mr-1"></i> Corregido Por (Sector)</label>
                        <select id="c-corregido" class="input-field" onchange="checkOtro('c-corregido', 'c-corregido-otro-box')">
                            <option value="RECEPCI√ìN">RECEPCI√ìN</option>
                            <option value="PREPARACI√ìN">PREPARACI√ìN</option>
                            <option value="EXPEDICI√ìN">EXPEDICI√ìN</option>
                            <option value="HIGIENE Y SEGURIDAD">HIGIENE Y SEGURIDAD</option>
                            <option value="OTRO">OTRO (ESPECIFICAR)</option>
                        </select>
                    </div>
                    <!-- Corregido OTRO -->
                    <div id="c-corregido-otro-box" class="mb-4" style="display:none;">
                        <label class="label" style="color: var(--safety-orange);">Especificar Sector</label>
                        <input type="text" id="c-corregido-otro" class="input-field otro-field" placeholder="Escriba el sector..." style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <!-- Turno Cierre -->
                    <div class="mb-4">
                        <label class="label"><i class="fa-regular fa-clock mr-1"></i> Turno Cierre</label>
                        <select id="c-turno-cierre" class="input-field">
                            <option value="MA√ëANA">MA√ëANA</option>
                            <option value="TARDE">TARDE</option>
                            <option value="NOCHE">NOCHE</option>
                        </select>
                    </div>

                    <!-- Foto Cierre -->
                    <div class="mb-5">
                        <label class="label"><i class="fa-solid fa-camera mr-1"></i> Fotograf√≠a de la Correcci√≥n <span class="text-red-500">*</span></label>
                        <input type="file" id="c-foto" accept="image/*" capture="environment" onchange="recibirFoto('c-foto','c-foto-preview','c-foto-btn',false)" style="display:none">
                        <input type="file" id="c-foto-galeria" accept="image/*" onchange="recibirFoto('c-foto-galeria','c-foto-preview','c-foto-btn',false)" style="display:none">
                        <button type="button" id="c-foto-btn" class="camera-btn" onclick="abrirModalFoto('c-foto','c-foto-galeria','c-foto-preview','c-foto-btn')">
                            <i class="fa-solid fa-camera"></i>
                            TOMAR FOTO DE LA CORRECCI√ìN
                        </button>
                        <div id="c-foto-preview" class="photo-preview mt-3" style="display: none;" onclick="enlargePhoto('c-foto')">
                            <button onclick="deletePhoto(event, 'c-foto', 'c-foto-preview', 'c-foto-btn')" class="photo-delete-btn">üóëÔ∏è BORRAR</button>
                        </div>
                    </div>

                    <div class="drive-info mb-4">
                        <i class="fa-brands fa-google-drive mr-2"></i>
                        La foto de cierre se guardar√° en Drive con nombre: <em>CIERRE-NAVE-CALLE-POS_FECHA.jpg</em>
                    </div>

                    <button onclick="guardarCierreDesvio()" class="btn-success">
                        <i class="fa-solid fa-check-circle mr-2"></i> CONFIRMAR CIERRE
                    </button>
                </div>
            </div>
        </section>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB: HISTORIAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <section id="content-historial" style="display: none;">
            <!-- KPI Row -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="kpi-card" style="background: linear-gradient(135deg, #E11D48, #BE123C); color: white;">
                    <div class="kpi-value" id="hist-pendientes">0</div>
                    <div class="kpi-label">PENDIENTES</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #22C55E, #15803D); color: white;">
                    <div class="kpi-value" id="hist-cerrados">0</div>
                    <div class="kpi-label">CERRADOS</div>
                </div>
            </div>

            <!-- Filter -->
            <div class="card mb-3" style="padding: 14px;">
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="label">Filtrar por Nave</label>
                        <select id="hist-filter-nave" class="input-field" style="font-size: 14px; padding: 10px;" onchange="renderHistorial()">
                            <option value="">Todas</option>
                            <option value="A">Nave A</option>
                            <option value="B">Nave B</option>
                            <option value="C">Nave C</option>
                            <option value="D">Nave D</option>
                            <option value="D-S">Nave D-S</option>
                            <option value="E">Nave E</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Filtrar por Estado</label>
                        <select id="hist-filter-estado" class="input-field" style="font-size: 14px; padding: 10px;" onchange="renderHistorial()">
                            <option value="">Todos</option>
                            <option value="ABIERTO">Abiertos</option>
                            <option value="CERRADO">Cerrados</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Info sobre auto-ocultar desv√≠os cerrados -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 rounded-lg">
                <p class="text-xs text-blue-800">
                    <i class="fa-solid fa-info-circle mr-1"></i>
                    <strong>Nota:</strong> Los desv√≠os cerrados se ocultan autom√°ticamente despu√©s de 36 horas. Los datos permanecen en el sistema y siguen visibles en las estad√≠sticas.
                </p>
            </div>

            <div id="historial-list"></div>
        </section>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB: ESTAD√çSTICAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <section id="content-stats" style="display: none;">
            <!-- KPI Grid -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="kpi-card" style="background: linear-gradient(135deg, #0F172A, #1E293B); color: white;">
                    <div class="kpi-value text-orange-400" id="stat-total">0</div>
                    <div class="kpi-label">TOTAL DESV√çOS</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #FF8C00, #CC6600); color: white;">
                    <div class="kpi-value" id="stat-tasa">0%</div>
                    <div class="kpi-label">TASA DE CIERRE</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #E11D48, #9F1239); color: white;">
                    <div class="kpi-value" id="stat-pendientes">0</div>
                    <div class="kpi-label">PENDIENTES</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #22C55E, #15803D); color: white;">
                    <div class="kpi-value" id="stat-promedio">0h</div>
                    <div class="kpi-label">PROM. CIERRE</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="card">
                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wide">üìä Estado General</h3>
                <div class="chart-container"><canvas id="chart-estado"></canvas></div>
            </div>
            <div class="card">
                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wide">üè≠ Desv√≠os por Nave</h3>
                <div class="chart-container"><canvas id="chart-nave"></canvas></div>
            </div>
            <div class="card">
                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wide">üéØ Tipo de Falla</h3>
                <div class="chart-container"><canvas id="chart-tipo"></canvas></div>
            </div>
            <div class="card">
                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wide">üìà Tendencia Temporal</h3>
                <div class="chart-container"><canvas id="chart-temporal"></canvas></div>
            </div>
            <div class="card">
                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wide">üïê Cierres por Turno</h3>
                <div class="chart-container"><canvas id="chart-turno-cierre"></canvas></div>
            </div>
            <div class="card">
                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wide">üîç Detectado Por</h3>
                <div class="chart-container"><canvas id="chart-detectado"></canvas></div>
            </div>
            <div class="card">
                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wide">üë§ Usuario que Cierra</h3>
                <div class="chart-container"><canvas id="chart-usuario-cierra"></canvas></div>
            </div>
            <div class="card">
                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wide">üîß Corregido Por</h3>
                <div class="chart-container"><canvas id="chart-corregido"></canvas></div>
            </div>
            <div class="card">
                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wide">üè¢ Cliente/Proveedor</h3>
                <div class="chart-container"><canvas id="chart-cliente"></canvas></div>
            </div>
            <div class="card">
                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wide">üìä Desv√≠os por Nivel</h3>
                <div class="chart-container"><canvas id="chart-nivel"></canvas></div>
            </div>
            <div class="card">
                <h3 class="text-sm font-black text-slate-800 mb-4 uppercase tracking-wide">üìà Tendencia de Rendimiento</h3>
                <div class="chart-container"><canvas id="chart-tendencia"></canvas></div>
            </div>

            <!-- Botones organizados en grupos -->
            <div class="space-y-4">
                <!-- Grupo 1: Acciones de Exportaci√≥n -->
                <div>
                    <p class="text-xs font-bold text-slate-600 mb-2 uppercase tracking-wide">
                        <i class="fa-solid fa-file-export mr-1"></i> Exportaci√≥n de Datos
                    </p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="compartirExcel()" class="btn-success">
                            <i class="fa-solid fa-share-nodes mr-2"></i> COMPARTIR EXCEL
                        </button>
                        <button onclick="mostrarOpcionesExcel()" class="btn-orange">
                            <i class="fa-solid fa-file-excel mr-2"></i> DESCARGAR EXCEL
                        </button>
                    </div>
                </div>

                <!-- Grupo 2: Gesti√≥n de Dashboard -->
                <div>
                    <p class="text-xs font-bold text-slate-600 mb-2 uppercase tracking-wide">
                        <i class="fa-solid fa-database mr-1"></i> Gesti√≥n de Dashboard
                    </p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="sincronizarSheets()" class="btn-primary">
                            <i class="fa-solid fa-download mr-2"></i> RECARGAR DESDE SHEETS
                        </button>
                        <button onclick="vaciarDashboard()" class="bg-red-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:bg-red-700 transition-all" style="border-bottom: 4px solid #991B1B;">
                            <i class="fa-solid fa-broom mr-2"></i> VACIAR DASHBOARD
                        </button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JAVASCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIGURACI√ìN PRINCIPAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ïë                      CONFIGURACI√ìN                          ‚ïë
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 
    // ‚úÖ URLs YA CONFIGURADAS POR DEFECTO
    // Este dashboard viene pre-configurado para conectarse autom√°ticamente
    // a la infraestructura de Google Drive y Sheets de CD Esteban Echeverr√≠a.
    // 
    // NO necesitas cambiar nada para que funcione - solo descarga y usa.
    //
    // Si necesitas cambiar alguna configuraci√≥n, las URLs est√°n debajo.
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const CONFIG = {
        appVersion: "V4.1",
        
        // Google Sheets - Planilla de datos
        sheetUrl: "https://docs.google.com/spreadsheets/d/1td9Llz1dewlm8iolw9CLpe2Ntr6fOm24hh2H5-PcRpU/edit",
        
        // Google Apps Script - API Backend (YA CONFIGURADO)
        gasUrl: "https://script.google.com/macros/s/AKfycbxRBswAv5mvMgAfix7n7BbMXcwc67ZmUat2F9nJgsxI7bzikSiigSUVRyk4wjdIXngEbA/exec",
        
        // Google Drive - Carpeta de fotos
        driveRootFolder: "PalletPRO_Fotos",
        
        // Informaci√≥n del centro de distribuci√≥n
        cdNombre: "CD ESTEBAN ECHEVERR√çA",
        
        // Roles de acceso
        adminRoles: ["ADMIN"],
        statsRoles: ["ADMIN", "SUPERVISOR"]
    };

    // Usuarios del sistema (desde planilla Excel - hoja USUARIOS)
    const USERS_DB = [
        { nombre: "ADMIN",              clave: "1234", rol: "ADMIN" },
        { nombre: "LOPEZ HERNAN",       clave: "4508", rol: "SUPERVISOR" },
        { nombre: "RENZO MOLINA",       clave: "8220", rol: "SUPERVISOR" },
        { nombre: "STEIN DIEGO",        clave: "4792", rol: "SUPERVISOR" },
        { nombre: "DE MASI GABRIEL",    clave: "3063", rol: "SUPERVISOR" },
        { nombre: "ACOSTA GABRIEL",     clave: "8190", rol: "USUARIO" },
        { nombre: "ARTASA JUAN",        clave: "8189", rol: "USUARIO" },
        { nombre: "AUGUSTO DANIEL",     clave: "4571", rol: "USUARIO" },
        { nombre: "BANCORA SANTIAGO",   clave: "3759", rol: "USUARIO" },
        { nombre: "CEBALLOS LUIS",      clave: "4998", rol: "USUARIO" },
        { nombre: "CUETO VI√ëAZ LUCAS",  clave: "4347", rol: "USUARIO" },
        { nombre: "DIAZ JOSE LUIS",     clave: "4870", rol: "USUARIO" },
        { nombre: "DUARTE SERGIO",      clave: "8979", rol: "USUARIO" },
        { nombre: "FLOREZ EZEQUIEL",    clave: "2398", rol: "USUARIO" },
        { nombre: "FOSCO NICOLAS",      clave: "9837", rol: "USUARIO" },
        { nombre: "GALLEGUILLO ESTEBAN",clave: "3615", rol: "USUARIO" },
        { nombre: "GARCIA QUINTIN",     clave: "7389", rol: "USUARIO" },
        { nombre: "GENTILE PATRICIO",   clave: "1452", rol: "USUARIO" },
        { nombre: "GODOY MARCOS",       clave: "7761", rol: "USUARIO" },
        { nombre: "GONZALEZ DIEGO",     clave: "6457", rol: "USUARIO" },
        { nombre: "LABUDI JUAN",        clave: "9273", rol: "USUARIO" },
        { nombre: "MAIDANA IGNACIO",    clave: "2417", rol: "USUARIO" },
        { nombre: "MAKARSKI JAVIER",    clave: "1767", rol: "USUARIO" },
        { nombre: "OCAMPOS LUCAS",      clave: "11928",rol: "USUARIO" },
        { nombre: "PEREZ ANDRES",       clave: "2421", rol: "USUARIO" },
        { nombre: "PICARDI PABLO",      clave: "6685", rol: "USUARIO" },
        { nombre: "QUIROGA JAVIER",     clave: "1127", rol: "USUARIO" },
        { nombre: "ROBERTO DOLS",       clave: "4412", rol: "USUARIO" },
        { nombre: "RODRIGUEZ PABLO",    clave: "1898", rol: "USUARIO" },
        { nombre: "SPINDOLA JORGE",     clave: "7149", rol: "USUARIO" },
        { nombre: "VEGA DANIEL",        clave: "6475", rol: "USUARIO" },
        { nombre: "VELAZQUEZ ANIBAL",   clave: "6224", rol: "USUARIO" }
    ];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ESTADO GLOBAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let APP_DATA = [];
    let CURRENT_USER = null;
    let STATS_ACCESS_GRANTED = false;
    let chartInstances = {};
    let autoTurnoInterval = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INICIALIZACI√ìN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.onload = async function() {
        // Poblar selects de usuarios
        populateUserSelects();
        // Reloj
        updateDateTime();
        setInterval(updateDateTime, 1000);
        // Auto turno por horario
        setAutoTurno();
        // Cargar datos guardados
        await loadDataFromStorage();
        
        // Si no hay datos locales, intentar cargar desde Sheets autom√°ticamente
        if (APP_DATA.length === 0 && CONFIG.gasUrl && !CONFIG.gasUrl.includes('REEMPLAZAR')) {
            console.log('No hay datos locales. Cargando desde Sheets...');
            await cargarDesdeSheetsEnSegundoPlano();
        }
        
        // Verificar conexi√≥n con Sheets
        checkSheetsConnection();
    };

    function populateUserSelects() {
        const loginSel = document.getElementById('login-user');
        const statsSel = document.getElementById('stats-user');
        const cierreSel = document.getElementById('c-usuario-cierra');

        USERS_DB.forEach(u => {
            const opt = `<option value="${u.nombre}">${u.nombre}</option>`;
            loginSel.innerHTML += opt;
            cierreSel.innerHTML += opt;
            // Stats solo supervisores y admins
            if (u.rol === 'ADMIN' || u.rol === 'SUPERVISOR') {
                statsSel.innerHTML += opt;
            }
        });
    }

    function setAutoTurno() {
        const h = new Date().getHours();
        let turno = 'MA√ëANA';
        if (h >= 14 && h < 22) turno = 'TARDE';
        else if (h >= 22 || h < 6) turno = 'NOCHE';

        const selNuevo = document.getElementById('n-turno');
        if (selNuevo) selNuevo.value = turno;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONEXI√ìN CON GOOGLE SHEETS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function checkSheetsConnection() {
        const sheetsStatus = document.getElementById('sheets-status');
        const sheetsDot = sheetsStatus.querySelector('.status-dot');
        const driveStatus = document.getElementById('drive-status');
        const driveDot = driveStatus.querySelector('.status-dot');

        if (!CONFIG.gasUrl || CONFIG.gasUrl.includes('REEMPLAZAR')) {
            sheetsStatus.classList.add('disconnected');
            sheetsStatus.classList.remove('connected');
            sheetsDot.classList.add('off');
            sheetsDot.classList.remove('on');
            
            driveStatus.classList.add('disconnected');
            driveStatus.classList.remove('connected');
            driveDot.classList.add('off');
            driveDot.classList.remove('on');
            return;
        }

        try {
            const response = await fetch(CONFIG.gasUrl, { 
                method: 'GET',
                mode: 'cors'
            });
            const data = await response.json();
            
            if (data.status === 'OK') {
                sheetsStatus.classList.add('connected');
                sheetsStatus.classList.remove('disconnected');
                sheetsDot.classList.add('on');
                sheetsDot.classList.remove('off');
                
                driveStatus.classList.add('connected');
                driveStatus.classList.remove('disconnected');
                driveDot.classList.add('on');
                driveDot.classList.remove('off');
                
                console.log('‚úÖ Conectado a Google Sheets y Drive');
            } else {
                throw new Error('Invalid response');
            }
        } catch(e) {
            sheetsStatus.classList.add('disconnected');
            sheetsStatus.classList.remove('connected');
            sheetsDot.classList.add('off');
            sheetsDot.classList.remove('on');
            
            driveStatus.classList.add('disconnected');
            driveStatus.classList.remove('connected');
            driveDot.classList.add('off');
            driveDot.classList.remove('on');
            
            console.log('‚ùå Sin conexi√≥n:', e.message);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LOGIN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function appLogin() {
        const userName = document.getElementById('login-user').value;
        const pin = document.getElementById('login-pin').value;
        const errEl = document.getElementById('login-error');

        if (!userName) {
            errEl.textContent = '‚ùå Seleccione un usuario';
            errEl.style.display = 'block';
            return;
        }

        const found = USERS_DB.find(u => u.nombre === userName && String(u.clave) === String(pin));

        if (found) {
            CURRENT_USER = found;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('user-display').textContent = found.nombre + ' ¬∑ ' + found.rol;
            errEl.style.display = 'none';
            renderHistorial();
            cargarDesviosPendientes();
        } else {
            errEl.style.display = 'block';
            document.getElementById('login-pin').value = '';
        }
    }

    document.getElementById('login-pin').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') appLogin();
    });

    function logout() {
        if (confirm('¬øEst√° seguro que desea salir?')) {
            CURRENT_USER = null;
            STATS_ACCESS_GRANTED = false;
            location.reload();
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ACCESO A ESTAD√çSTICAS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function requestStatsAccess() {
        if (STATS_ACCESS_GRANTED) {
            showTab('stats');
            return;
        }
        document.getElementById('stats-login').style.display = 'flex';
        document.getElementById('stats-error').style.display = 'none';
        document.getElementById('stats-pin').value = '';
    }

    function closeStatsLogin() {
        document.getElementById('stats-login').style.display = 'none';
    }

    function verifyStatsAccess() {
        const userName = document.getElementById('stats-user').value;
        const pin = document.getElementById('stats-pin').value;
        const errEl = document.getElementById('stats-error');

        if (!userName) {
            errEl.textContent = '‚ùå Seleccione un usuario';
            errEl.style.display = 'block';
            return;
        }

        const user = USERS_DB.find(u =>
            u.nombre === userName &&
            String(u.clave) === String(pin) &&
            (u.rol === 'ADMIN' || u.rol === 'SUPERVISOR')
        );

        if (user) {
            STATS_ACCESS_GRANTED = true;
            closeStatsLogin();
            showTab('stats');
            renderStats();
        } else {
            errEl.style.display = 'block';
            document.getElementById('stats-pin').value = '';
        }
    }

    document.getElementById('stats-pin').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') verifyStatsAccess();
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NAVEGACI√ìN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showTab(tabName) {
        if (tabName === 'stats' && !STATS_ACCESS_GRANTED) {
            requestStatsAccess();
            return;
        }

        ['nuevo','cerrar','historial','stats'].forEach(t => {
            const content = document.getElementById('content-' + t);
            const btn = document.getElementById('tab-btn-' + t);
            if (content) content.style.display = 'none';
            if (btn) btn.classList.remove('active');
        });

        document.getElementById('content-' + tabName).style.display = 'block';
        document.getElementById('tab-btn-' + tabName).classList.add('active');

        if (tabName === 'historial') renderHistorial();
        else if (tabName === 'cerrar') cargarDesviosPendientes();
        else if (tabName === 'stats') renderStats();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RELOJ Y FECHA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateDateTime() {
        const now = new Date();
        document.getElementById('current-date').textContent = now.toLocaleDateString('es-AR', { weekday:'short', day:'2-digit', month:'2-digit', year:'numeric' });
        document.getElementById('current-time').textContent = now.toLocaleTimeString('es-AR', { hour:'2-digit', minute:'2-digit' });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CAMPO "OTRO"
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function checkOtro(selectId, boxId) {
        const val = document.getElementById(selectId).value;
        const box = document.getElementById(boxId);
        if (val === 'OTRO') {
            box.style.display = 'block';
            box.classList.add('slide-up');
        } else {
            box.style.display = 'none';
        }
    }

    function getFieldValue(selectId, otroId) {
        const sel = document.getElementById(selectId);
        if (sel.value === 'OTRO') {
            const otroVal = document.getElementById(otroId).value.trim().toUpperCase();
            return otroVal || null;
        }
        return sel.value;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FOTOGRAF√çA ‚Äî Modal selector + Editor (solo n-foto)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // Almacena el dataURL editado para cada inputId (solo n-foto)
    const _editedPhotos = {};

    // Variable interna del modal selector
    let _modalFotoTarget = { camId: null, galId: null, prevId: null, btnId: null };

    // Abre el modal de elecci√≥n c√°mara/galer√≠a
    function abrirModalFoto(camId, galId, prevId, btnId) {
        _modalFotoTarget = { camId, galId, prevId, btnId };
        const modal = document.getElementById('modal-foto-selector');
        modal.style.display = 'flex';
        document.getElementById('modal-btn-camara').onclick = function() {
            cerrarModalFoto();
            document.getElementById(_modalFotoTarget.camId).click();
        };
        document.getElementById('modal-btn-galeria').onclick = function() {
            cerrarModalFoto();
            document.getElementById(_modalFotoTarget.galId).click();
        };
    }
    function cerrarModalFoto() {
        document.getElementById('modal-foto-selector').style.display = 'none';
    }

    // Callback compartido para ambos inputs (c√°mara y galer√≠a)
    // abrirEditor=true  ‚Üí abre editor de anotaciones (solo n-foto)
    // abrirEditor=false ‚Üí muestra preview directo (c-foto)
    function recibirFoto(srcId, prevId, btnId, abrirEditor) {
        // Determinar el inputId can√≥nico (n-foto o c-foto) para guardar _editedPhotos
        const canonId = srcId.replace('-galeria', '');
        const src = document.getElementById(srcId);
        if (!src.files || !src.files[0]) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            if (abrirEditor) {
                abrirEditorFoto(e.target.result, canonId, prevId, btnId);
            } else {
                // Sin editor: mostrar preview directamente
                mostrarPreview(e.target.result, canonId, prevId, btnId);
            }
        };
        reader.readAsDataURL(src.files[0]);
    }

    // Muestra la imagen en el preview y actualiza el bot√≥n
    function mostrarPreview(dataUrl, canonId, prevId, btnId) {
        const preview = document.getElementById(prevId);
        const btn = document.getElementById(btnId);
        if (preview) {
            preview.style.backgroundImage = 'url(' + dataUrl + ')';
            preview.style.display = 'block';
            preview.dataset.dataUrl = dataUrl; // guardar para enlargePhoto
        }
        if (btn) {
            btn.style.borderColor = 'var(--apple-green)';
            btn.style.color = 'var(--apple-green)';
            btn.innerHTML = '<i class="fa-solid fa-check-circle" style="font-size:22px; display:block; margin-bottom:4px;"></i>FOTO CARGADA ‚Äî TOQUE PARA CAMBIAR';
        }
    }

    function deletePhoto(event, inputId, previewId, btnId) {
        event.stopPropagation();
        const input = document.getElementById(inputId);
        const galeriaInput = document.getElementById(inputId + '-galeria');
        const preview = document.getElementById(previewId);
        const btn = document.getElementById(btnId);

        if (input) input.value = '';
        if (galeriaInput) galeriaInput.value = '';
        delete _editedPhotos[inputId];

        preview.style.display = 'none';
        preview.style.backgroundImage = '';
        preview.dataset.dataUrl = '';

        if (btn) {
            btn.style.borderColor = '';
            btn.style.color = '';
            const isCierre = inputId.includes('c-foto');
            btn.innerHTML = isCierre
                ? '<i class="fa-solid fa-camera"></i>TOMAR FOTO DE LA CORRECCI√ìN'
                : '<i class="fa-solid fa-camera"></i>TOMAR FOTO / GALER√çA';
        }
    }

    function enlargePhoto(inputId) {
        // Priorizar: foto editada ‚Üí dataUrl en preview ‚Üí input file
        const previewId = inputId + '-preview';
        const preview = document.getElementById(previewId);
        const edited = _editedPhotos[inputId];
        const stored = preview && preview.dataset.dataUrl;

        if (edited) {
            document.getElementById('photo-viewer-img').src = edited;
            document.getElementById('photo-viewer').style.display = 'flex';
            return;
        }
        if (stored) {
            document.getElementById('photo-viewer-img').src = stored;
            document.getElementById('photo-viewer').style.display = 'flex';
            return;
        }
        const input = document.getElementById(inputId);
        if (!input || !input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('photo-viewer-img').src = e.target.result;
            document.getElementById('photo-viewer').style.display = 'flex';
        };
        reader.readAsDataURL(input.files[0]);
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // EDITOR DE IMAGEN (solo para n-foto)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const _ed = {
        tool: 'circle', canvas: null, ctx: null,
        baseImage: null, strokes: [], drawing: false,
        startX: 0, startY: 0, penPath: [],
        targetInputId: null, targetPreviewId: null, targetBtnId: null,
        scale: 1
    };

    function abrirEditorFoto(dataUrl, inputId, previewId, btnId) {
        _ed.targetInputId  = inputId;
        _ed.targetPreviewId = previewId;
        _ed.targetBtnId    = btnId;
        _ed.strokes        = [];
        _ed.tool           = 'circle';
        setEditorTool('circle');

        document.getElementById('modal-editor-foto').style.display = 'flex';

        const img = new Image();
        img.onload = function() {
            _ed.baseImage = img;
            const canvas = document.getElementById('editor-canvas');
            _ed.canvas = canvas;
            _ed.ctx    = canvas.getContext('2d');

            const dpr  = window.devicePixelRatio || 1;
            const maxW = Math.min(window.innerWidth - 16, 560);
            const maxH = window.innerHeight * 0.52;
            let cW = img.naturalWidth, cH = img.naturalHeight;
            if (cW > maxW) { cH = Math.round(cH * maxW / cW); cW = maxW; }
            if (cH > maxH) { cW = Math.round(cW * maxH / cH); cH = maxH; }

            canvas.width  = Math.round(cW * dpr);
            canvas.height = Math.round(cH * dpr);
            canvas.style.width  = cW + 'px';
            canvas.style.height = cH + 'px';
            _ed.scale = dpr;

            redrawEditor();
            bindEditorEvents(canvas);
        };
        img.src = dataUrl;
    }

    function setEditorTool(tool) {
        _ed.tool = tool;
        ['circle','arrow','pen'].forEach(function(t) {
            const btn = document.getElementById('editor-tool-' + t);
            if (!btn) return;
            const active = t === tool;
            btn.style.background  = active ? '#ef4444' : '#334155';
            btn.style.borderColor = active ? '#ef4444' : '#475569';
            btn.style.color       = active ? '#fff'    : '#94a3b8';
        });
    }

    function redrawEditor() {
        const c = _ed.canvas, ctx = _ed.ctx, sc = _ed.scale;
        ctx.clearRect(0, 0, c.width, c.height);
        ctx.drawImage(_ed.baseImage, 0, 0, c.width, c.height);
        ctx.strokeStyle = '#FF2222';
        ctx.lineWidth   = 3 * sc;
        ctx.lineCap = ctx.lineJoin = 'round';
        _ed.strokes.forEach(function(s) {
            ctx.beginPath();
            if (s.type === 'circle') {
                ctx.ellipse(s.cx * sc, s.cy * sc, s.rx * sc, s.ry * sc, 0, 0, Math.PI * 2);
                ctx.stroke();
            } else if (s.type === 'arrow') {
                drawArrow(ctx, s.x1*sc, s.y1*sc, s.x2*sc, s.y2*sc, sc);
            } else if (s.type === 'pen' && s.pts.length > 1) {
                ctx.moveTo(s.pts[0].x * sc, s.pts[0].y * sc);
                for (let i = 1; i < s.pts.length; i++) ctx.lineTo(s.pts[i].x * sc, s.pts[i].y * sc);
                ctx.stroke();
            }
        });
    }

    function drawArrow(ctx, x1, y1, x2, y2, sc) {
        const hl = 18 * sc, a = Math.atan2(y2 - y1, x2 - x1);
        ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - hl * Math.cos(a - Math.PI/7), y2 - hl * Math.sin(a - Math.PI/7));
        ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - hl * Math.cos(a + Math.PI/7), y2 - hl * Math.sin(a + Math.PI/7));
        ctx.stroke();
    }

    function getPos(canvas, ev) {
        const r = canvas.getBoundingClientRect();
        const s = ev.touches ? ev.touches[0] : ev;
        return {
            x: (s.clientX - r.left) * (canvas.width  / r.width  / _ed.scale),
            y: (s.clientY - r.top)  * (canvas.height / r.height / _ed.scale)
        };
    }

    function bindEditorEvents(canvas) {
        const nc = canvas.cloneNode(true);
        canvas.parentNode.replaceChild(nc, canvas);
        _ed.canvas = nc; _ed.ctx = nc.getContext('2d');
        redrawEditor();

        function onStart(e) {
            e.preventDefault(); _ed.drawing = true;
            const p = getPos(nc, e);
            _ed.startX = p.x; _ed.startY = p.y;
            if (_ed.tool === 'pen') _ed.penPath = [p];
        }
        function onMove(e) {
            if (!_ed.drawing) return; e.preventDefault();
            const p = getPos(nc, e);
            if (_ed.tool === 'pen') {
                _ed.penPath.push(p);
                redrawEditor();
                const ctx = _ed.ctx, sc = _ed.scale;
                ctx.strokeStyle = '#FF2222'; ctx.lineWidth = 3*sc;
                ctx.lineCap = ctx.lineJoin = 'round';
                ctx.beginPath();
                ctx.moveTo(_ed.penPath[0].x*sc, _ed.penPath[0].y*sc);
                _ed.penPath.forEach(function(pt) { ctx.lineTo(pt.x*sc, pt.y*sc); });
                ctx.stroke();
            } else {
                redrawEditor();
                const ctx = _ed.ctx, sc = _ed.scale;
                ctx.strokeStyle = '#FF2222'; ctx.lineWidth = 3*sc;
                ctx.lineCap = ctx.lineJoin = 'round';
                ctx.beginPath();
                if (_ed.tool === 'circle') {
                    const rx = Math.abs(p.x - _ed.startX)/2, ry = Math.abs(p.y - _ed.startY)/2;
                    ctx.ellipse((_ed.startX+p.x)/2*sc, (_ed.startY+p.y)/2*sc, rx*sc, ry*sc, 0, 0, Math.PI*2);
                } else {
                    drawArrow(ctx, _ed.startX*sc, _ed.startY*sc, p.x*sc, p.y*sc, sc);
                }
                ctx.stroke();
            }
        }
        function onEnd(e) {
            if (!_ed.drawing) return; _ed.drawing = false; e.preventDefault();
            const src = e.changedTouches ? e.changedTouches[0] : e;
            const r   = nc.getBoundingClientRect();
            const ex  = (src.clientX - r.left) * (nc.width  / r.width  / _ed.scale);
            const ey  = (src.clientY - r.top)  * (nc.height / r.height / _ed.scale);
            if (_ed.tool === 'circle') {
                const rx = Math.abs(ex-_ed.startX)/2, ry = Math.abs(ey-_ed.startY)/2;
                if (rx > 4 || ry > 4)
                    _ed.strokes.push({ type:'circle', cx:(_ed.startX+ex)/2, cy:(_ed.startY+ey)/2, rx, ry });
            } else if (_ed.tool === 'arrow') {
                const dx = ex-_ed.startX, dy = ey-_ed.startY;
                if (Math.sqrt(dx*dx+dy*dy) > 10)
                    _ed.strokes.push({ type:'arrow', x1:_ed.startX, y1:_ed.startY, x2:ex, y2:ey });
            } else if (_ed.penPath.length > 2) {
                _ed.strokes.push({ type:'pen', pts: _ed.penPath.slice() });
            }
            redrawEditor();
        }

        nc.addEventListener('mousedown',  onStart, { passive:false });
        nc.addEventListener('mousemove',  onMove,  { passive:false });
        nc.addEventListener('mouseup',    onEnd,   { passive:false });
        nc.addEventListener('touchstart', onStart, { passive:false });
        nc.addEventListener('touchmove',  onMove,  { passive:false });
        nc.addEventListener('touchend',   onEnd,   { passive:false });
    }

    function editorUndo()  { _ed.strokes.pop(); redrawEditor(); }
    function editorClear() { _ed.strokes = []; redrawEditor(); }

    function cancelarEditorFoto() {
        document.getElementById('modal-editor-foto').style.display = 'none';
        // limpiar inputs para que no quede archivo sin confirmar
        const inp = document.getElementById(_ed.targetInputId);
        const gal = document.getElementById(_ed.targetInputId + '-galeria');
        if (inp) inp.value = '';
        if (gal) gal.value = '';
    }

    function confirmarEditorFoto() {
        const dataUrl = _ed.canvas.toDataURL('image/jpeg', 0.88);
        _editedPhotos[_ed.targetInputId] = dataUrl;
        mostrarPreview(dataUrl, _ed.targetInputId, _ed.targetPreviewId, _ed.targetBtnId);
        document.getElementById('modal-editor-foto').style.display = 'none';
    }

    async function toBase64(file, inputId) {
        // Si hay foto editada (desde el editor), usarla directamente
        if (inputId && _editedPhotos[inputId]) {
            return _editedPhotos[inputId]; // dataURL completo
        }
        if (!file || file._edited) return (_editedPhotos[inputId] || null); // foto ya editada
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    let w = img.width, h = img.height;
                    if (w > MAX_WIDTH) { h = Math.round(h * MAX_WIDTH / w); w = MAX_WIDTH; }
                    // Tambi√©n limitar altura m√°xima
                    const MAX_HEIGHT = 600;
                    if (h > MAX_HEIGHT) { w = Math.round(w * MAX_HEIGHT / h); h = MAX_HEIGHT; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.55));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GENERAR NOMBRE DE FOTO (para Drive)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function generarNombreFoto(nave, calle, posicion, nivel, tipo = 'DESVIO') {
        const now = new Date();
        const fecha = now.toLocaleDateString('es-AR', { day:'2-digit', month:'2-digit', year:'numeric' }).replace(/\//g, '-');
        const hora = now.toLocaleTimeString('es-AR', { hour:'2-digit', minute:'2-digit' }).replace(/:/g, '-');
        return `${tipo}_NAVE${nave}_C${calle}_P${posicion}_N${nivel}_${fecha}_${hora}.jpg`;
    }

    // Genera la estructura de carpetas: PalletPRO_Fotos > NAVE_X > foto.jpg
    function generarRutaFoto(nave, nombreFoto, fecha = new Date()) {
        const year = fecha.getFullYear();
        const month = String(fecha.getMonth() + 1).padStart(2, '0');
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const monthName = monthNames[fecha.getMonth()];
        
        return `${CONFIG.driveRootFolder}/${year}/${month}_${monthName}/NAVE_${nave.toUpperCase()}/${nombreFoto}`;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GUARDAR NUEVO DESV√çO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function guardarNuevoDesvio() {
        const nave     = getFieldValue('n-nave', 'n-nave-otro');
        const turno    = document.getElementById('n-turno').value;
        const calle    = document.getElementById('n-calle').value.trim();
        const posicion = document.getElementById('n-posicion').value.trim();
        const nivel    = document.getElementById('n-nivel').value.trim();
        const estado   = getFieldValue('n-estado', 'n-estado-otro');
        const detectado= getFieldValue('n-detectado', 'n-detectado-otro');
        const fotoFile = (document.getElementById('n-foto').files[0]) || (document.getElementById('n-foto-galeria') && document.getElementById('n-foto-galeria').files[0]) || (_editedPhotos['n-foto'] ? { _edited: true } : null);

        // Validaciones
        if (!nave) { showAlert('Seleccione o especifique la Nave'); return; }
        if (!calle) { showAlert('Ingrese la Calle/Canal'); return; }
        if (!posicion) { showAlert('Ingrese la Posici√≥n'); return; }
        if (!nivel) { showAlert('Ingrese el Nivel'); return; }
        if (!estado) { showAlert('Especifique el Estado del Pallet'); return; }
        if (!detectado) { showAlert('Especifique qui√©n detect√≥ el desv√≠o'); return; }
        if (!fotoFile && !_editedPhotos['n-foto']) { showAlert('Debe tomar una fotograf√≠a del desv√≠o'); return; }

        // Confirmaci√≥n en dos pasos
        if (!confirm('¬øVerific√≥ todos los datos ingresados?\n\n' +
            'Nave: ' + nave + '\n' +
            'Ubicaci√≥n: Calle ' + calle + ', Posici√≥n ' + posicion + ', Nivel ' + nivel + '\n' +
            'Estado: ' + estado + '\n' +
            'Detectado por: ' + detectado)) {
            return;
        }

        if (!confirm('¬øConfirmar la generaci√≥n del desv√≠o?')) {
            return;
        }

        showLoader(true, 'Guardando desv√≠o...');

        const foto = await toBase64(fotoFile, 'n-foto');
        const now = new Date();
        const id = 'DEV-' + Date.now();
        const nDesvio = generateNumericId(); // CDEE-00000001 format
        const nombreFoto = generarNombreFoto(nave, calle, posicion, nivel, 'DESVIO');
        const rutaFoto = generarRutaFoto(nave, nombreFoto, now);

        const desvio = {
            id: id,
            nDesvio: nDesvio,
            usuarioReporta: CURRENT_USER.nombre,
            fechaReporte: now.toLocaleString('es-AR', { hour12: false }),  // Siempre 24h
            fechaReporteISO: now.toISOString(), // Para c√°lculos precisos de tiempo
            turnoReporte: turno,
            nave: nave,
            calle: calle,
            posicion: posicion,
            nivel: nivel,
            fotoDesvio: foto,
            nombreFotoDesvio: nombreFoto,
            rutaFotoDesvio: rutaFoto,
            detectadoPor: detectado,
            estadoPallet: estado,
            status: 'ABIERTO',
            // Cierre (se completa luego)
            usuarioCierra: null,
            fotoCierre: null,
            nombreFotoCierre: null,
            rutaFotoCierre: null,
            cerradoPor: null,
            turnoCierre: null,
            seCorrigio: null,
            fechaCierre: null,
            fechaCierreISO: null,
            cliente: null
        };

        APP_DATA.push(desvio);
        await saveDataToStorage();

        // Intentar sincronizar con Google Sheets en background
        sincronizarNuevoDesvio(desvio);

        // Limpiar form
        document.getElementById('n-calle').value = '';
        document.getElementById('n-posicion').value = '';
        document.getElementById('n-nivel').value = '';
        document.getElementById('n-foto').value = '';
        const nFotoGal = document.getElementById('n-foto-galeria'); if (nFotoGal) nFotoGal.value = '';
        delete _editedPhotos['n-foto'];
        document.getElementById('n-foto-preview').style.display = 'none';
        document.getElementById('n-nave').value = 'A';
        checkOtro('n-nave', 'n-nave-otro-box');
        checkOtro('n-estado', 'n-estado-otro-box');
        checkOtro('n-detectado', 'n-detectado-otro-box');
        const fotoBtn = document.getElementById('n-foto-btn');
        fotoBtn.style.borderColor = '';
        fotoBtn.style.color = '';
        fotoBtn.innerHTML = '<i class="fa-solid fa-camera"></i>TOMAR FOTO / GALER√çA';

        showLoader(false);
        showSuccess('Desv√≠o ' + nDesvio + ' guardado correctamente\n\nLa sincronizaci√≥n con Google Sheets se realiza autom√°ticamente en segundo plano.');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CERRAR DESV√çO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function cargarDesviosPendientes() {
        const select = document.getElementById('c-desvio');
        const pendientes = APP_DATA.filter(d => d.status === 'ABIERTO');
        select.innerHTML = '<option value="">‚Äî Seleccione un desv√≠o pendiente ‚Äî</option>';
        pendientes.forEach(d => {
            select.innerHTML += `<option value="${d.id}">N-${d.nave} | C.${d.calle} P.${d.posicion} NIV.${d.nivel} | ${d.estadoPallet}</option>`;
        });
    }

    function mostrarInfoDesvio() {
        const id = document.getElementById('c-desvio').value;
        const container = document.getElementById('c-info-container');

        if (!id) { 
            container.style.display = 'none'; 
            if (window.pendingTimeInterval) {
                clearInterval(window.pendingTimeInterval);
                window.pendingTimeInterval = null;
            }
            return; 
        }

        const desvio = APP_DATA.find(d => d.id === id);
        if (!desvio) return;

        // Usar ISO timestamp si est√° disponible, sino intentar parsear
        let reportTimestamp = null;
        if (desvio.fechaReporteISO) {
            reportTimestamp = new Date(desvio.fechaReporteISO).getTime();
        } else {
            // Fallback para desv√≠os viejos sin ISO
            try {
                const raw = desvio.fechaReporte;
                const match = raw.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})[,\s]+(\d{1,2}):(\d{2})/);
                if (match) {
                    reportTimestamp = new Date(
                        parseInt(match[3]),      // year
                        parseInt(match[2]) - 1, // month (0-indexed)
                        parseInt(match[1]),      // day
                        parseInt(match[4]),      // hour
                        parseInt(match[5])       // minute
                    ).getTime();
                }
            } catch(e) { reportTimestamp = null; }
        }

        // Funci√≥n para actualizar el tiempo en tiempo real
        function updatePendingTime() {
            if (!reportTimestamp) {
                document.getElementById('pending-time-display').textContent = '‚Äî';
                return;
            }
            
            const diffMs = Date.now() - reportTimestamp;
            if (isNaN(diffMs) || diffMs < 0) {
                document.getElementById('pending-time-display').textContent = '‚Äî';
                return;
            }
            
            const totalMins = Math.floor(diffMs / 60000);
            const hours = Math.floor(totalMins / 60);
            const mins = totalMins % 60;
            
            if (hours > 0) {
                document.getElementById('pending-time-display').textContent = `${hours}h ${mins}min`;
            } else {
                document.getElementById('pending-time-display').textContent = `${mins} min`;
            }
        }

        document.getElementById('c-info').innerHTML = `
            <p class="font-black text-slate-800 mb-2">üìã DESV√çO ${desvio.nDesvio || desvio.id}</p>
            <p>üë§ <strong>Reportado por:</strong> ${desvio.usuarioReporta}</p>
            <p>üìÖ <strong>Fecha:</strong> ${desvio.fechaReporte}</p>
            <p>üïê <strong>Turno:</strong> ${desvio.turnoReporte}</p>
            <p>üìç <strong>Ubicaci√≥n:</strong> Nave ${desvio.nave} ‚Äî Calle ${desvio.calle} ‚Äî Pos. ${desvio.posicion} ‚Äî Nivel ${desvio.nivel}</p>
            <p class="text-red-700 font-black">‚ö†Ô∏è <strong>Estado:</strong> ${desvio.estadoPallet}</p>
            <p>üîç <strong>Detectado por:</strong> ${desvio.detectadoPor}</p>
            <p class="text-orange-600 font-black mt-1">‚è±Ô∏è Tiempo pendiente: <span id="pending-time-display">‚Äî</span></p>
        `;

        container.style.display = 'block';

        // Limpiar intervalo anterior si existe
        if (window.pendingTimeInterval) {
            clearInterval(window.pendingTimeInterval);
        }

        // Actualizar inmediatamente
        updatePendingTime();

        // Actualizar cada segundo
        window.pendingTimeInterval = setInterval(updatePendingTime, 1000);

        // Auto-turno cierre
        const h = new Date().getHours();
        let turno = 'MA√ëANA';
        if (h >= 14 && h < 22) turno = 'TARDE';
        else if (h >= 22 || h < 6) turno = 'NOCHE';
        document.getElementById('c-turno-cierre').value = turno;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EDITAR Y ELIMINAR DESV√çO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function editarDesvio() {
        const id = document.getElementById('c-desvio').value;
        if (!id) {
            alert('Seleccione un desv√≠o para editar');
            return;
        }

        const desvio = APP_DATA.find(d => d.id === id);
        if (!desvio) {
            alert('No se encontr√≥ el desv√≠o. Intent√° sincronizar con Sheets primero.');
            return;
        }

        // Cargar TODOS los campos en el modal incluyendo nave
        document.getElementById('edit-desvio-id').textContent = id;
        document.getElementById('edit-nave').value      = desvio.nave        || '';
        document.getElementById('edit-calle').value     = desvio.calle       || '';
        document.getElementById('edit-posicion').value  = desvio.posicion    || '';
        document.getElementById('edit-nivel').value     = desvio.nivel       || '';

        // Estado pallet ‚Äî manejar valor OTRO
        const estadoSelect = document.getElementById('edit-estado');
        const estadoOtroBox = document.getElementById('edit-estado-otro-box');
        const estadoOtroInput = document.getElementById('edit-estado-otro');
        const estadoOpciones = Array.from(estadoSelect.options).map(o => o.value);
        if (estadoOpciones.includes(desvio.estadoPallet)) {
            estadoSelect.value = desvio.estadoPallet || '';
            estadoOtroBox.style.display = 'none';
        } else {
            estadoSelect.value = 'OTRO';
            estadoOtroInput.value = desvio.estadoPallet || '';
            estadoOtroBox.style.display = 'block';
        }

        // Detectado por ‚Äî manejar valor OTRO
        const detectadoSelect = document.getElementById('edit-detectado');
        const detectadoOtroBox = document.getElementById('edit-detectado-otro-box');
        const detectadoOtroInput = document.getElementById('edit-detectado-otro');
        const detectadoOpciones = Array.from(detectadoSelect.options).map(o => o.value);
        if (detectadoOpciones.includes(desvio.detectadoPor)) {
            detectadoSelect.value = desvio.detectadoPor || '';
            detectadoOtroBox.style.display = 'none';
        } else {
            detectadoSelect.value = 'OTRO';
            detectadoOtroInput.value = desvio.detectadoPor || '';
            detectadoOtroBox.style.display = 'block';
        }

        // Mostrar modal
        document.getElementById('edit-modal').style.display = 'flex';
    }

    function cerrarModalEditar() {
        document.getElementById('edit-modal').style.display = 'none';
    }

    async function guardarEdicion() {
        const id = document.getElementById('edit-desvio-id').textContent;
        const desvio = APP_DATA.find(d => d.id === id);
        
        if (!desvio) return;

        // Actualizar todos los campos editables incluyendo nave
        const estadoVal = document.getElementById('edit-estado').value;
        const detectadoVal = document.getElementById('edit-detectado').value;
        desvio.nave        = document.getElementById('edit-nave').value.trim().toUpperCase();
        desvio.calle       = document.getElementById('edit-calle').value.trim().toUpperCase();
        desvio.posicion    = document.getElementById('edit-posicion').value.trim().toUpperCase();
        desvio.nivel       = document.getElementById('edit-nivel').value.trim().toUpperCase();
        desvio.estadoPallet= (estadoVal === 'OTRO'
            ? document.getElementById('edit-estado-otro').value.trim().toUpperCase()
            : estadoVal.trim().toUpperCase());
        desvio.detectadoPor= (detectadoVal === 'OTRO'
            ? document.getElementById('edit-detectado-otro').value.trim().toUpperCase()
            : detectadoVal.trim().toUpperCase());

        // Guardar localmente
        await saveDataToStorage();

        // Sincronizar con Google Sheets
        sincronizarEdicionDesvio(desvio);

        // Cerrar modal
        document.getElementById('edit-modal').style.display = 'none';

        // Mostrar √©xito
        showSuccess('Desv√≠o actualizado correctamente');

        // Refrescar dropdown si estamos en cerrar
        if (document.getElementById('tab-btn-cerrar').classList.contains('active')) {
            cargarDesviosPendientes();
        }
    }

    async function eliminarDesvio() {
        const id = document.getElementById('c-desvio').value;
        if (!id) {
            alert('Seleccione un desv√≠o para eliminar');
            return;
        }

        const desvio = APP_DATA.find(d => d.id === id);
        if (!desvio) return;

        if (!confirm('‚ö†Ô∏è ELIMINAR desv√≠o ' + (desvio.nDesvio || desvio.id) + '?\n\n' +
            'Nave: ' + desvio.nave + '\n' +
            'Ubicaci√≥n: Calle ' + desvio.calle + '\n\n' +
            'NO se puede deshacer.')) {
            return;
        }

        if (!confirm('¬øConfirmar eliminaci√≥n?')) {
            return;
        }

        showLoader(true, 'Eliminando...');

        const index = APP_DATA.findIndex(d => d.id === id);
        if (index > -1) {
            APP_DATA.splice(index, 1);
        }

        await saveDataToStorage();
        showLoader(false);
        alert('Desv√≠o eliminado del dashboard.\n\nPara eliminarlo de Sheets, borre la fila manualmente.');

        document.getElementById('c-desvio').value = '';
        document.getElementById('c-info-container').style.display = 'none';
        cargarDesviosPendientes();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CERRAR DESV√çO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function guardarCierreDesvio() {
        const id = document.getElementById('c-desvio').value;
        const usuarioCierra = document.getElementById('c-usuario-cierra').value;
        const pinCierra = document.getElementById('c-pin-cierra').value;
        const cliente = document.getElementById('c-cliente').value.trim().toUpperCase();
        const corregido = getFieldValue('c-corregido', 'c-corregido-otro');
        const turnoCierre = document.getElementById('c-turno-cierre').value;
        const fotoFile = (document.getElementById('c-foto').files[0]) || (document.getElementById('c-foto-galeria') && document.getElementById('c-foto-galeria').files[0]);

        // Validaciones
        if (!id) { showAlert('Seleccione un desv√≠o pendiente'); return; }
        if (!usuarioCierra) { showAlert('Seleccione el usuario que cierra'); return; }
        if (!pinCierra) { showAlert('Ingrese el PIN de confirmaci√≥n'); return; }

        // Verificar PIN del usuario que cierra
        const userCierra = USERS_DB.find(u => u.nombre === usuarioCierra && String(u.clave) === String(pinCierra));
        if (!userCierra) { showAlert('PIN incorrecto para el usuario seleccionado'); return; }

        if (!cliente) { showAlert('Ingrese el Cliente/Proveedor'); return; }
        if (!corregido) { showAlert('Especifique qui√©n corrigi√≥ el desv√≠o'); return; }
        if (!fotoFile) { showAlert('Debe tomar una fotograf√≠a de la correcci√≥n'); return; }

        showLoader(true, 'Procesando foto...');

        try {
            const foto = await toBase64(fotoFile, 'c-foto');
            
            showLoader(true, 'Cerrando desv√≠o...');
            
            const desvio = APP_DATA.find(d => d.id === id);
            const now = new Date();

            const nombreFotoCierre = generarNombreFoto(desvio.nave, desvio.calle, desvio.posicion, desvio.nivel, 'CIERRE');
            const rutaFotoCierre = generarRutaFoto(desvio.nave, nombreFotoCierre, now);

            desvio.status = 'CERRADO';
            desvio.usuarioCierra = usuarioCierra;
            desvio.fotoCierre = foto;
            desvio.nombreFotoCierre = nombreFotoCierre;
            desvio.rutaFotoCierre = rutaFotoCierre;
            desvio.cerradoPor = corregido;
            desvio.turnoCierre = turnoCierre;
            desvio.seCorrigio = 'SI';
            desvio.fechaCierre = now.toLocaleString('es-AR', { hour12: false });  // Siempre 24h
            desvio.fechaCierreISO = now.toISOString();
            desvio.cliente = cliente;

            await saveDataToStorage();

            // Limpiar intervalo de tiempo pendiente
            if (window.pendingTimeInterval) {
                clearInterval(window.pendingTimeInterval);
                window.pendingTimeInterval = null;
            }

            // Sincronizar cierre con Google Sheets
            sincronizarCierreDesvio(desvio);

            // Limpiar form
            document.getElementById('c-desvio').value = '';
            document.getElementById('c-usuario-cierra').value = '';
            document.getElementById('c-pin-cierra').value = '';
            document.getElementById('c-cliente').value = '';
            document.getElementById('c-foto').value = '';
            const cFotoGal = document.getElementById('c-foto-galeria'); if (cFotoGal) cFotoGal.value = '';
            document.getElementById('c-foto-preview').style.display = 'none';
            document.getElementById('c-info-container').style.display = 'none';
            checkOtro('c-corregido', 'c-corregido-otro-box');
            const fotoBtn = document.getElementById('c-foto-btn');
            fotoBtn.style.borderColor = '';
            fotoBtn.style.color = '';
            fotoBtn.innerHTML = '<i class="fa-solid fa-camera"></i>TOMAR FOTO DE LA CORRECCI√ìN';

            showLoader(false);
            showSuccess('Desv√≠o cerrado correctamente');
            
        } catch(error) {
            showLoader(false);
            showAlert('Error al procesar el cierre. Por favor intente nuevamente.');
            console.error('Error:', error);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HISTORIAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderHistorial() {
        const filterNave = document.getElementById('hist-filter-nave').value;
        const filterEstado = document.getElementById('hist-filter-estado').value;

        // Filtro de 36 horas para desv√≠os cerrados (solo en HISTORIAL, NO en gr√°ficos)
        const THIRTY_SIX_HOURS = 36 * 60 * 60 * 1000;
        const now = new Date();
        
        let data = APP_DATA.filter(d => {
            // ABIERTOS: siempre mostrar
            if (d.status === 'ABIERTO') return true;
            
            // CERRADOS: solo mostrar si tienen menos de 36 horas
            if (d.status === 'CERRADO') {
                if (!d.fechaCierreISO) return true; // Desv√≠os viejos sin ISO, mostrar por defecto
                
                try {
                    const fechaCierre = new Date(d.fechaCierreISO);
                    const diffMs = now.getTime() - fechaCierre.getTime();
                    return diffMs < THIRTY_SIX_HOURS; // Solo mostrar si tiene menos de 36 horas
                } catch(e) {
                    return true; // En caso de error, mostrar
                }
            }
            
            return true;
        });
        
        // Aplicar filtros del usuario
        if (filterNave) data = data.filter(d => d.nave === filterNave);
        if (filterEstado) data = data.filter(d => d.status === filterEstado);

        // Actualizar contadores (usar APP_DATA completo, no filtrado)
        const pendientes = APP_DATA.filter(d => d.status === 'ABIERTO').length;
        const cerrados = APP_DATA.filter(d => d.status === 'CERRADO').length;
        document.getElementById('hist-pendientes').textContent = pendientes;
        document.getElementById('hist-cerrados').textContent = cerrados;

        const container = document.getElementById('historial-list');
        container.innerHTML = '';

        if (data.length === 0) {
            container.innerHTML = `<div class="card text-center py-10">
                <i class="fa-solid fa-inbox text-4xl text-slate-300 mb-3"></i>
                <p class="text-slate-400 font-bold">No hay desv√≠os para mostrar</p>
                <p class="text-slate-400 text-xs mt-2">Los desv√≠os cerrados se ocultan autom√°ticamente despu√©s de 36 horas</p>
            </div>`;
            return;
        }

        data.sort((a, b) => {
            const dA = a.id.split('-')[1] || 0;
            const dB = b.id.split('-')[1] || 0;
            return dB - dA;
        }).forEach(d => {
            const card = document.createElement('div');
            card.className = `hist-card ${d.status === 'ABIERTO' ? 'abierto' : 'cerrado'}`;
            
            // Extraer fecha y hora
            const fechaApertura = d.fechaReporte ? d.fechaReporte.split(' ')[0] || d.fechaReporte.split(',')[0] : '';
            const horaApertura  = d.fechaReporte ? (d.fechaReporte.replace(',','').trim().split(' ')[1] || '') : '';
            const fechaCierre   = d.fechaCierre  ? d.fechaCierre.split(' ')[0] || d.fechaCierre.split(',')[0] : '‚Äî';
            const horaCierre    = d.fechaCierre  ? (d.fechaCierre.replace(',','').trim().split(' ')[1] || '') : '‚Äî';
            
            // Calcular tiempo pendiente usando getFechaLocal para respetar zona horaria
            let tiempoPendiente = '‚Äî';
            if (d.status === 'ABIERTO') {
                const apertura = getFechaLocal(d.fechaReporteISO, d.fechaReporte);
                if (apertura) {
                    const ahora  = new Date();
                    const diffMs = ahora - apertura;
                    if (diffMs >= 0) {
                        const totalMin = Math.floor(diffMs / 60000);
                        const horas    = Math.floor(totalMin / 60);
                        const mins     = totalMin % 60;
                        tiempoPendiente = horas > 0
                            ? horas + 'h ' + String(mins).padStart(2,'0') + 'm'
                            : mins + 'm';
                    } else {
                        tiempoPendiente = '< 1m';
                    }
                }
            }
            
            card.innerHTML = `
                <!-- Header con N¬∞ y Estado -->
                <div class="flex justify-between items-center mb-2 pb-2" style="border-bottom: 3px solid #1E293B;">
                    <div class="font-black text-slate-900" style="font-size: 15px; letter-spacing: 0.5px;">
                        ${d.nDesvio || d.id}
                    </div>
                    <span class="badge ${d.status === 'ABIERTO' ? 'badge-red' : 'badge-green'}" style="font-size:11px; padding:5px 12px; font-weight: 900;">
                        ${d.status}
                    </span>
                </div>
                
                <!-- Grid principal: Apertura | Cierre | Fotos -->
                <div class="grid" style="grid-template-columns: 1fr 1px 1fr 1fr; gap: 12px; font-size: 11px;">
                    
                    <!-- APERTURA -->
                    <div>
                        <div class="font-black text-slate-800 mb-2" style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Apertura
                        </div>
                        
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; line-height: 1.6;">
                            <div class="font-bold text-slate-600"><i class="fa-solid fa-user mr-1"></i>Usuario:</div>
                            <div class="text-slate-900">${d.usuarioReporta}</div>
                            
                            <div class="font-bold text-slate-600"><i class="fa-solid fa-calendar mr-1"></i>Fecha:</div>
                            <div class="text-slate-900">${fechaApertura}</div>
                            
                            <div class="font-bold text-slate-600"><i class="fa-solid fa-clock mr-1"></i>Hora:</div>
                            <div class="text-slate-900">${horaApertura}</div>
                            
                            <div class="font-bold text-slate-600"><i class="fa-regular fa-clock mr-1"></i>Turno:</div>
                            <div class="text-slate-900">${d.turnoReporte}</div>
                            
                            <div class="font-bold text-slate-600"><i class="fa-solid fa-map-marker-alt mr-1"></i>Ubicaci√≥n:</div>
                            <div class="text-slate-900">N.${d.nave} C.${d.calle} P.${d.posicion} Nv.${d.nivel}</div>
                            
                            <div class="font-bold text-slate-600"><i class="fa-solid fa-exclamation-triangle mr-1"></i>Estado:</div>
                            <div class="text-red-700 font-bold">${d.estadoPallet}</div>
                            
                            <div class="font-bold text-slate-600"><i class="fa-solid fa-eye mr-1"></i>Detectado por:</div>
                            <div class="text-slate-900">${d.detectadoPor}</div>
                        </div>
                    </div>
                    
                    <!-- L√≠nea divisoria vertical -->
                    <div style="background: #CBD5E1; width: 1px;"></div>
                    
                    <!-- CIERRE -->
                    <div>
                        <div class="font-black text-slate-800 mb-2" style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Cierre
                        </div>
                        
                        ${d.status === 'CERRADO' ? `
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; line-height: 1.6;">
                            <div class="font-bold text-slate-600"><i class="fa-solid fa-user-check mr-1"></i>Usuario:</div>
                            <div class="text-slate-900">${d.usuarioCierra || '‚Äî'}</div>
                            
                            <div class="font-bold text-slate-600"><i class="fa-solid fa-calendar-check mr-1"></i>Fecha:</div>
                            <div class="text-slate-900">${fechaCierre}</div>
                            
                            <div class="font-bold text-slate-600"><i class="fa-solid fa-clock mr-1"></i>Hora/D√≠a:</div>
                            <div class="text-slate-900">${horaCierre}</div>
                            
                            <div class="font-bold text-slate-600"><i class="fa-regular fa-clock mr-1"></i>Turno:</div>
                            <div class="text-slate-900">${d.turnoCierre || '‚Äî'}</div>
                            
                            <div class="font-bold text-slate-600"><i class="fa-solid fa-wrench mr-1"></i>Corregido por:</div>
                            <div class="text-slate-900">${d.cerradoPor || '‚Äî'}</div>
                            
                            <div class="font-bold text-slate-600"><i class="fa-solid fa-building mr-1"></i>Cliente/Proveedor:</div>
                            <div class="text-slate-900">${d.cliente || '‚Äî'}</div>
                        </div>
                        ` : `
                        <div class="text-center text-slate-400 pt-8">
                            <i class="fa-solid fa-hourglass-half text-3xl mb-2"></i>
                            <p style="font-size: 10px; font-weight: 700;">PENDIENTE DE CIERRE</p>
                            ${d.status === 'ABIERTO' ? `
                            <p class="text-orange-600 font-black mt-2" style="font-size: 12px;">
                                <i class="fa-solid fa-stopwatch mr-1"></i>${tiempoPendiente}
                            </p>
                            ` : ''}
                        </div>
                        `}
                    </div>
                    
                    <!-- FOTOS -->
                    <div style="display: flex; flex-direction: column; gap: 12px; align-items: stretch;">
                        ${(d.fotoDesvio || d.rutaFotoDesvio || d.nombreFotoDesvio) ? `
                        <button onclick="verFoto('${d.fotoDesvio || d.rutaFotoDesvio || d.nombreFotoDesvio}')" 
                                class="bg-gradient-to-br from-red-600 via-red-700 to-red-800 text-white rounded-xl font-black shadow-xl hover:shadow-2xl hover:scale-105 transition-all duration-200 flex flex-col items-center justify-center" 
                                style="font-size: 10px; padding: 16px 12px; border: 4px solid #7F1D1D; letter-spacing: 0.5px; min-height: 85px;">
                            <i class="fa-solid fa-camera" style="font-size: 28px; margin-bottom: 6px;"></i>
                            <div>FOTO DESV√çO</div>
                        </button>
                        ` : `
                        <button class="bg-slate-200 text-slate-400 rounded-xl font-black flex flex-col items-center justify-center" 
                                style="font-size: 10px; padding: 16px 12px; border: 4px solid #CBD5E1; letter-spacing: 0.5px; min-height: 85px;" 
                                disabled>
                            <i class="fa-solid fa-camera" style="font-size: 28px; margin-bottom: 6px;"></i>
                            <div>FOTO DESV√çO</div>
                        </button>
                        `}
                        
                        ${(d.fotoCierre || d.rutaFotoCierre || d.nombreFotoCierre) ? `
                        <button onclick="verFoto('${d.fotoCierre || d.rutaFotoCierre || d.nombreFotoCierre}')" 
                                class="bg-gradient-to-br from-green-600 via-green-700 to-green-800 text-white rounded-xl font-black shadow-xl hover:shadow-2xl hover:scale-105 transition-all duration-200 flex flex-col items-center justify-center" 
                                style="font-size: 10px; padding: 16px 12px; border: 4px solid #14532D; letter-spacing: 0.5px; min-height: 85px;">
                            <i class="fa-solid fa-camera" style="font-size: 28px; margin-bottom: 6px;"></i>
                            <div>FOTO CIERRE</div>
                        </button>
                        ` : `
                        <button class="bg-slate-200 text-slate-400 rounded-xl font-black flex flex-col items-center justify-center" 
                                style="font-size: 10px; padding: 16px 12px; border: 4px solid #CBD5E1; letter-spacing: 0.5px; min-height: 85px;" 
                                disabled>
                            <i class="fa-solid fa-camera" style="font-size: 28px; margin-bottom: 6px;"></i>
                            <div>FOTO CIERRE</div>
                        </button>
                        `}
                    </div>
                    
                </div>
            `;
            container.appendChild(card);
        });
    }

    function verFoto(url) {
        if (!url || url === 'null' || url === 'undefined' || url.trim() === '') {
            alert('‚ö†Ô∏è No hay fotograf√≠a disponible para este desv√≠o.');
            return;
        }
        // Si es URL de Drive ‚Üí abrir en nueva pesta√±a
        if (url.startsWith('http')) {
            window.open(url, '_blank');
            return;
        }
        // Si es base64 ‚Üí mostrar en visor interno
        document.getElementById('photo-viewer-img').src = url;
        document.getElementById('photo-viewer').style.display = 'flex';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ESTAD√çSTICAS Y GR√ÅFICOS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderStats() {
        const total = APP_DATA.length;
        const cerrados = APP_DATA.filter(d => d.status === 'CERRADO').length;
        const pendientes = APP_DATA.filter(d => d.status === 'ABIERTO').length;
        const tasa = total > 0 ? ((cerrados / total) * 100).toFixed(1) : 0;

        // Calcular tiempo promedio de cierre
        let totalHoras = 0, countCerrado = 0;
        APP_DATA.filter(d => d.status === 'CERRADO').forEach(d => {
            const fechaApertura = getFechaLocal(d.fechaReporteISO, d.fechaReporte);
            const fechaCierre   = getFechaLocal(d.fechaCierreISO,  d.fechaCierre);
            if (fechaApertura && fechaCierre) {
                const horas = (fechaCierre - fechaApertura) / 3600000;
                if (horas >= 0 && horas < 8760) {
                    totalHoras += horas;
                    countCerrado++;
                }
            }
        });
        const promedio = countCerrado > 0 ? (totalHoras / countCerrado).toFixed(1) : 0;

        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-tasa').textContent = tasa + '%';
        document.getElementById('stat-pendientes').textContent = pendientes;
        document.getElementById('stat-promedio').textContent = promedio + 'h';

        renderChartEstado();
        renderChartNave();
        renderChartTipo();
        renderChartTemporal();
        renderChartTurnoCierre();
        renderChartDetectado();
        renderChartUsuarioCierra();
        renderChartCorregido();
        renderChartCliente();
        renderChartNivel();
        renderChartTendencia();
    }

    // Parsea fecha en cualquier formato argentino:
    // "DD/MM/YYYY, HH:MM:SS" (local), "DD/MM/YYYY HH:MM" (Sheets), "DD/MM/YYYY HH:MM:SS"
    // Devuelve Date local SIN desplazamiento de zona horaria
    function parseFechaAR(str) {
        if (!str || str.trim() === '') return null;
        try {
            // Normalizar: quitar comas, colapsar espacios
            const s = str.trim().replace(',', '').replace(/\s+/g, ' ');
            const partes = s.split(' ');
            const dateParts = partes[0].split('/');
            if (dateParts.length < 3) return null;

            const dia  = parseInt(dateParts[0], 10);
            const mes  = parseInt(dateParts[1], 10) - 1;
            const anio = parseInt(dateParts[2], 10);

            // Detectar AM/PM en cualquier formato ("pm", "p.m.", "p. m.", "PM")
            const restoStr = partes.slice(1).join(' ').toLowerCase();
            const esPM = restoStr.indexOf('p') !== -1;
            const esAM = restoStr.indexOf('a') !== -1;

            const timeParts = (partes[1] || '00:00').split(':');
            let hh = parseInt(timeParts[0] || '0', 10);
            const mm = parseInt(timeParts[1] || '0', 10);
            const ss = parseInt(timeParts[2] || '0', 10);

            // Convertir a 24h si hay indicador AM/PM
            if (esPM && hh < 12) hh += 12;
            if (esAM && hh === 12) hh = 0;

            // Crear fecha como local (sin UTC offset) para respetar hora Argentina
            const d = new Date(anio, mes, dia, hh, mm, ss);
            if (isNaN(d.getTime())) return null;
            return d;
        } catch(e) { return null; }
    }

    // Devuelve el objeto Date correcto priorizando ISO con offset, luego parseFechaAR
    function getFechaLocal(isoStr, strFecha) {
        if (isoStr) {
            const d = new Date(isoStr); // Si tiene -03:00 el navegador lo respeta
            if (!isNaN(d.getTime())) return d;
        }
        return parseFechaAR(strFecha);
    }

    function destroyChart(id) {
        if (chartInstances[id]) { chartInstances[id].destroy(); delete chartInstances[id]; }
    }

    function renderChartEstado() {
        destroyChart('estado');
        const abiertos = APP_DATA.filter(d => d.status === 'ABIERTO').length;
        const cerrados = APP_DATA.filter(d => d.status === 'CERRADO').length;
        const ctx = document.getElementById('chart-estado').getContext('2d');
        chartInstances.estado = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Abiertos', 'Cerrados'],
                datasets: [{ data: [abiertos, cerrados], backgroundColor: ['#E11D48', '#22C55E'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderChartNave() {
        destroyChart('nave');
        const naves = {};
        APP_DATA.forEach(d => { naves[`Nave ${d.nave}`] = (naves[`Nave ${d.nave}`] || 0) + 1; });
        const ordenNaves = ['Nave A','Nave B','Nave C','Nave D','Nave D-S','Nave E'];
const labelsOrdenados = [
    ...ordenNaves.filter(n => naves[n] !== undefined),
    ...Object.keys(naves).filter(n => !ordenNaves.includes(n)).sort()
];
const valoresOrdenados = labelsOrdenados.map(n => naves[n]);
            data: {
                labels: labelsOrdenados,
datasets: [{ label: 'Desv√≠os', data: valoresOrdenados, backgroundColor: '#FF8C00', borderRadius: 8 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    function renderChartTipo() {
        destroyChart('tipo');
        const tipos = {};
        APP_DATA.forEach(d => { tipos[d.estadoPallet] = (tipos[d.estadoPallet] || 0) + 1; });
        const ctx = document.getElementById('chart-tipo').getContext('2d');
        chartInstances.tipo = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(tipos),
                datasets: [{ data: Object.values(tipos), backgroundColor: ['#FF8C00','#E11D48','#22C55E','#0F172A','#6366F1','#F59E0B'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderChartTemporal() {
        destroyChart('temporal');
        const meses = {};
        APP_DATA.forEach(d => {
            const fecha = getFechaLocal(d.fechaReporteISO, d.fechaReporte);
            if (fecha) {
                const mes = fecha.toLocaleDateString('es-AR', { month: 'short', year: 'numeric' });
                meses[mes] = (meses[mes] || 0) + 1;
            }
        });
        const ctx = document.getElementById('chart-temporal').getContext('2d');
        chartInstances.temporal = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(meses),
                datasets: [{
                    label: 'Desv√≠os por mes',
                    data: Object.values(meses),
                    borderColor: '#FF8C00',
                    backgroundColor: 'rgba(255,140,0,0.12)',
                    fill: true, tension: 0.4, pointBackgroundColor: '#FF8C00', pointRadius: 5
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    function renderChartTurnoCierre() {
        destroyChart('turnoCierre');
        const turnos = { 'MA√ëANA': 0, 'TARDE': 0, 'NOCHE': 0 };
        APP_DATA.filter(d => d.status === 'CERRADO' && d.turnoCierre).forEach(d => {
            if (turnos[d.turnoCierre] !== undefined) turnos[d.turnoCierre]++;
        });
        const ctx = document.getElementById('chart-turno-cierre').getContext('2d');
        chartInstances.turnoCierre = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(turnos),
                datasets: [{ label: 'Cierres', data: Object.values(turnos), backgroundColor: ['#0F172A','#FF8C00','#1E293B'], borderRadius: 8 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }

    function renderChartDetectado() {
        destroyChart('detectado');
        const detectados = {};
        APP_DATA.forEach(d => { 
            const key = (d.detectadoPor || 'SIN ESPECIFICAR').toUpperCase();
            detectados[key] = (detectados[key] || 0) + 1; 
        });
        const ctx = document.getElementById('chart-detectado').getContext('2d');
        chartInstances.detectado = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(detectados),
                datasets: [{ data: Object.values(detectados), backgroundColor: ['#FF8C00','#E11D48','#22C55E','#0F172A','#6366F1','#F59E0B','#8B5CF6'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderChartUsuarioCierra() {
        destroyChart('usuarioCierra');
        const usuarios = {};
        APP_DATA.filter(d => d.status === 'CERRADO' && d.usuarioCierra).forEach(d => {
            const key = d.usuarioCierra.toUpperCase();
            usuarios[key] = (usuarios[key] || 0) + 1;
        });
        
        // Top 10 usuarios
        const sorted = Object.entries(usuarios).sort((a,b) => b[1] - a[1]).slice(0, 10);
        const labels = sorted.map(x => x[0]);
        const data = sorted.map(x => x[1]);
        
        const ctx = document.getElementById('chart-usuario-cierra').getContext('2d');
        chartInstances.usuarioCierra = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Cierres', data: data, backgroundColor: '#22C55E', borderRadius: 8 }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { beginAtZero: true, ticks: { stepSize: 1 } },
                    x: { ticks: { autoSkip: false, maxRotation: 90, minRotation: 45 } }
                } 
            }
        });
    }

    function renderChartCorregido() {
        destroyChart('corregido');
        const corregidos = {};
        APP_DATA.filter(d => d.status === 'CERRADO' && d.cerradoPor).forEach(d => {
            const key = (d.cerradoPor || 'SIN ESPECIFICAR').toUpperCase();
            corregidos[key] = (corregidos[key] || 0) + 1;
        });
        const ctx = document.getElementById('chart-corregido').getContext('2d');
        chartInstances.corregido = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(corregidos),
                datasets: [{ data: Object.values(corregidos), backgroundColor: ['#FF8C00','#E11D48','#22C55E','#0F172A','#6366F1','#F59E0B'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderChartCliente() {
        destroyChart('cliente');
        const clientes = {};
        APP_DATA.filter(d => d.status === 'CERRADO' && d.cliente).forEach(d => {
            const key = d.cliente.toUpperCase();
            clientes[key] = (clientes[key] || 0) + 1;
        });
        
        // Top 10 clientes
        const sorted = Object.entries(clientes).sort((a,b) => b[1] - a[1]).slice(0, 10);
        const labels = sorted.map(x => x[0]);
        const data = sorted.map(x => x[1]);
        
        const ctx = document.getElementById('chart-cliente').getContext('2d');
        chartInstances.cliente = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Desv√≠os', data: data, backgroundColor: '#6366F1', borderRadius: 8 }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    y: { beginAtZero: true, ticks: { stepSize: 1 } },
                    x: { ticks: { autoSkip: false, maxRotation: 90, minRotation: 45 } }
                } 
            }
        });
    }

    function renderChartNivel() {
        destroyChart('nivel');
        const niveles = {};
        APP_DATA.forEach(d => {
            const key = 'Nivel ' + (d.nivel || 'N/A');
            niveles[key] = (niveles[key] || 0) + 1;
        });
        
        const sorted = Object.entries(niveles).sort((a,b) => {
            const numA = parseInt(a[0].replace('Nivel ', '')) || 999;
            const numB = parseInt(b[0].replace('Nivel ', '')) || 999;
            return numA - numB;
        });
        
        const labels = sorted.map(x => x[0]);
        const data = sorted.map(x => x[1]);
        
        const ctx = document.getElementById('chart-nivel').getContext('2d');
        chartInstances.nivel = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Desv√≠os',
                    data: data,
                    backgroundColor: '#8B5CF6',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
    }

    function renderChartTendencia() {
        destroyChart('tendencia');
        
        // Agrupar desv√≠os por mes
        const datosPorMes = {};
        
        APP_DATA.forEach(d => {
            const fecha = getFechaLocal(d.fechaReporteISO, d.fechaReporte);
            if (!fecha) return;
            
            const mesKey = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
            
            if (!datosPorMes[mesKey]) {
                datosPorMes[mesKey] = { total: 0, cerrados: 0, tiemposCierre: [] };
            }
            
            datosPorMes[mesKey].total++;
            
            if (d.status === 'CERRADO') {
                const apertura = getFechaLocal(d.fechaReporteISO, d.fechaReporte);
                const cierre   = getFechaLocal(d.fechaCierreISO,  d.fechaCierre);
                if (apertura && cierre) {
                    datosPorMes[mesKey].cerrados++;
                    const horas = (cierre - apertura) / 3600000;
                    if (horas >= 0 && horas < 8760) {
                        datosPorMes[mesKey].tiemposCierre.push(horas);
                    }
                }
            }
        });
        
        // Ordenar por fecha y tomar √∫ltimos 6 meses
        const meses = Object.keys(datosPorMes).sort().slice(-6);
        
        const labels = meses.map(m => {
            const [year, month] = m.split('-');
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return monthNames[parseInt(month) - 1] + ' ' + year;
        });
        
        const tasaCierre = meses.map(m => {
            const datos = datosPorMes[m];
            return datos.total > 0 ? ((datos.cerrados / datos.total) * 100).toFixed(1) : 0;
        });
        
        const promedioCierre = meses.map(m => {
            const tiempos = datosPorMes[m].tiemposCierre;
            if (tiempos.length === 0) return 0;
            const suma = tiempos.reduce((a, b) => a + b, 0);
            return (suma / tiempos.length).toFixed(1);
        });
        
        const ctx = document.getElementById('chart-tendencia').getContext('2d');
        chartInstances.tendencia = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Tasa de Cierre (%)',
                        data: tasaCierre,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        yAxisID: 'y-tasa',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#10B981'
                    },
                    {
                        label: 'Promedio Cierre (hrs)',
                        data: promedioCierre,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        yAxisID: 'y-promedio',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#3B82F6'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                label += context.parsed.y;
                                if (context.dataset.yAxisID === 'y-tasa') label += '%';
                                else label += ' hrs';
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    'y-tasa': {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Tasa de Cierre (%)' },
                        beginAtZero: true,
                        max: 100
                    },
                    'y-promedio': {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Promedio Horas' },
                        beginAtZero: true,
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ALMACENAMIENTO (localStorage + window.storage)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function saveDataToStorage() {
        const dataStr = JSON.stringify(APP_DATA);
        // Intentar window.storage (Claude)
        try {
            if (window.storage) {
                await window.storage.set('palletpro_v4_data', dataStr, false);
                return;
            }
        } catch(e) { /* silenciar */ }
        // Fallback localStorage
        try { localStorage.setItem('palletpro_v4_data', dataStr); } catch(e) { console.warn('Storage fallback failed:', e); }
    }

    async function loadDataFromStorage() {
        // Intentar window.storage
        try {
            if (window.storage) {
                const result = await window.storage.get('palletpro_v4_data', false);
                if (result && result.value) { APP_DATA = JSON.parse(result.value); return; }
            }
        } catch(e) { /* silenciar */ }
        // Fallback localStorage
        try {
            const raw = localStorage.getItem('palletpro_v4_data');
            if (raw) APP_DATA = JSON.parse(raw);
        } catch(e) { APP_DATA = []; }
    }

    async function cargarDesdeSheetsEnSegundoPlano() {
        try {
            const response = await fetch(CONFIG.gasUrl + '?accion=GET_ALL_DATA', {
                method: 'GET',
                mode: 'cors'
            });

            const result = await response.json();

            if (result.ok && result.data && Array.isArray(result.data)) {
                APP_DATA.length = 0;
                APP_DATA.push(...result.data);
                await saveDataToStorage();
                console.log('‚úÖ Datos cargados desde Sheets:', APP_DATA.length, 'desv√≠os');
            }
        } catch(e) {
            console.log('No se pudo cargar desde Sheets al inicio:', e.message);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ACTUALIZAR DESDE SHEETS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function recargarDesdeSheets() {
        if (!CONFIG.gasUrl || CONFIG.gasUrl.includes('REEMPLAZAR')) {
            alert('‚ö†Ô∏è Configure la URL del script primero');
            return;
        }

        if (!confirm('¬øRecargar datos desde Google Sheets?\n\nEsto sobrescribir√° los datos locales.')) {
            return;
        }

        showLoader(true, 'Descargando desde Sheets...');

        try {
            const response = await fetch(CONFIG.gasUrl + '?accion=GET_ALL_DATA', {
                method: 'GET',
                mode: 'cors'
            });

            const result = await response.json();

            if (result.error) {
                throw new Error(result.error);
            }

            if (result.data && Array.isArray(result.data)) {
                APP_DATA.length = 0;
                APP_DATA.push(...result.data);
                await saveDataToStorage();

                showLoader(false);
                showSuccess('Datos actualizados desde Google Sheets\n\n' + APP_DATA.length + ' desv√≠os sincronizados');

                const activeTab = document.querySelector('.nav-btn.active');
                if (activeTab) {
                    const tabName = activeTab.id.replace('tab-btn-', '');
                    if (tabName === 'historial') renderHistorial();
                    else if (tabName === 'stats') renderStats();
                }
            } else {
                throw new Error('Formato inv√°lido');
            }

        } catch(error) {
            showLoader(false);
            alert('‚ùå Error: ' + error.message);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SINCRONIZACI√ìN GOOGLE SHEETS / DRIVE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RECARGAR DESDE SHEETS (ACTUALIZAR)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function recargarDesdeSheets() {
        if (!CONFIG.gasUrl || CONFIG.gasUrl.includes('REEMPLAZAR')) {
            alert('‚ö†Ô∏è Google Apps Script no configurado.\n\nPor favor configura la URL del script en CONFIG.gasUrl');
            return;
        }

        if (!confirm('¬øRecargar todos los datos desde Google Sheets?\n\nEsto sobrescribir√° los datos locales con los datos de la planilla.')) {
            return;
        }

        showLoader(true, 'Descargando datos de Sheets...');

        try {
            const response = await fetch(CONFIG.gasUrl + '?accion=GET_ALL_DATA', {
                method: 'GET',
                mode: 'cors'
            });

            if (!response.ok) {
                throw new Error('Error al conectar con Sheets');
            }

            const result = await response.json();

            if (result.error) {
                throw new Error(result.error);
            }

            if (result.data && Array.isArray(result.data)) {
                APP_DATA.length = 0;
                APP_DATA.push(...result.data);

                await saveDataToStorage();

                showLoader(false);
                showSuccess('Datos actualizados desde Google Sheets\n\n' + APP_DATA.length + ' desv√≠os sincronizados');

                const activeTab = document.querySelector('.nav-btn.active');
                if (activeTab) {
                    const tabName = activeTab.id.replace('tab-btn-', '');
                    if (tabName === 'historial') renderHistorial();
                    else if (tabName === 'stats') renderStats();
                }
            } else {
                throw new Error('Formato de datos inv√°lido');
            }

        } catch(error) {
            showLoader(false);
            alert('‚ùå Error al actualizar datos:\n\n' + error.message + '\n\nVerifica que el Google Apps Script est√© correctamente configurado.');
            console.error('Error recargando datos:', error);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SINCRONIZACI√ìN GOOGLE SHEETS / DRIVE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function sincronizarNuevoDesvio(desvio) {
        // Si hay URL de GAS configurada, enviar datos
        if (!CONFIG.gasUrl || CONFIG.gasUrl.includes('REEMPLAZAR')) return;
        try {
            const payload = {
                accion: 'NUEVO_DESVIO',
                nDesvio: desvio.nDesvio,
                usuarioReporta: desvio.usuarioReporta,
                fechaReporte: desvio.fechaReporte,
                turnoReporte: desvio.turnoReporte,
                nave: desvio.nave,
                calle: desvio.calle,
                posicion: desvio.posicion,
                nivel: desvio.nivel,
                detectadoPor: desvio.detectadoPor,
                estadoPallet: desvio.estadoPallet,
                nombreFoto: desvio.nombreFotoDesvio,
                rutaFoto: desvio.rutaFotoDesvio,
                fotoBase64: desvio.fotoDesvio,
                carpetaNaveDrive: `NAVE_${desvio.nave}`
            };
            await fetch(CONFIG.gasUrl, { method: 'POST', mode: 'cors', body: JSON.stringify(payload) });
        } catch(e) { console.log('Sync background fall√≥ (no cr√≠tico):', e.message); }
    }


    async function sincronizarEdicionDesvio(desvio) {
        if (!CONFIG.gasUrl || CONFIG.gasUrl.includes('REEMPLAZAR')) return;
        try {
            const payload = {
                accion:       'EDITAR_DESVIO',
                nDesvio:      desvio.nDesvio,
                nave:         desvio.nave,
                calle:        desvio.calle,
                posicion:     desvio.posicion,
                nivel:        desvio.nivel,
                estadoPallet: desvio.estadoPallet,
                detectadoPor: desvio.detectadoPor
            };
            await fetch(CONFIG.gasUrl, { method: 'POST', mode: 'cors', body: JSON.stringify(payload) });
            console.log('‚úÖ Edici√≥n sincronizada con Sheets:', desvio.nDesvio);
        } catch(e) {
            console.log('Sync edici√≥n fall√≥ (no cr√≠tico):', e.message);
        }
    }

    async function sincronizarCierreDesvio(desvio) {
        if (!CONFIG.gasUrl || CONFIG.gasUrl.includes('REEMPLAZAR')) return;
        try {
            const payload = {
                accion: 'CIERRE_DESVIO',
                id: desvio.id,
                nDesvio: desvio.nDesvio,
                usuarioCierra: desvio.usuarioCierra,
                fotoCierreBase64: desvio.fotoCierre,
                nombreFotoCierre: desvio.nombreFotoCierre,
                rutaFotoCierre: desvio.rutaFotoCierre,
                cerradoPor: desvio.cerradoPor,
                turnoCierre: desvio.turnoCierre,
                seCorrigio: desvio.seCorrigio,
                fechaCierre: desvio.fechaCierre,
                cliente: desvio.cliente,
                carpetaNaveDrive: `NAVE_${desvio.nave}`
            };
            await fetch(CONFIG.gasUrl, { method: 'POST', mode: 'cors', body: JSON.stringify(payload) });
        } catch(e) { console.log('Sync cierre fall√≥ (no cr√≠tico):', e.message); }
    }

    async function sincronizarSheets() {
        if (!CONFIG.gasUrl || CONFIG.gasUrl.includes('REEMPLAZAR')) {
            alert('‚ö†Ô∏è Para sincronizar con Google Sheets, configure la URL del Google Apps Script en la variable CONFIG.gasUrl');
            return;
        }

        if (!confirm('üìä CARGAR DATOS DESDE GOOGLE SHEETS\n\nEsto descargar√° TODOS los desv√≠os de la planilla y actualizar√° el dashboard.\n\nLos datos de la planilla son la fuente de verdad.\n\n¬øContinuar?')) {
            return;
        }

        showLoader(true, 'Descargando datos de Google Sheets...');

        try {
            const response = await fetch(CONFIG.gasUrl + '?accion=GET_ALL_DATA', {
                method: 'GET',
                mode: 'cors'
            });

            if (!response.ok) {
                throw new Error('Error al conectar con Sheets');
            }

            const result = await response.json();

            if (result.error) {
                throw new Error(result.error);
            }

            if (result.data && Array.isArray(result.data)) {
                // Reemplazar APP_DATA con los datos de Sheets
                APP_DATA.length = 0;
                APP_DATA.push(...result.data);

                await saveDataToStorage();

                showLoader(false);
                showSuccess('‚úÖ Datos cargados desde Google Sheets\n\n' + APP_DATA.length + ' desv√≠os sincronizados\n\nLos gr√°ficos se actualizar√°n autom√°ticamente.');

                // Refrescar la vista de estad√≠sticas
                renderStats();
            } else {
                throw new Error('Formato de datos inv√°lido');
            }

        } catch(e) {
            showLoader(false);
            alert('‚ùå Error al cargar datos:\n\n' + e.message + '\n\nVerifica que el Google Apps Script est√© correctamente configurado.');
            console.error('Error sincronizando:', e);
        }
    }

    async function vaciarDashboard() {
        if (!confirm('‚ö†Ô∏è VACIAR DASHBOARD\n\nEsto eliminar√° TODOS los desv√≠os del dashboard local.\n\nLos datos en Google Sheets NO se borrar√°n.\n\nRecomendaci√≥n: Usa esto para empezar de cero y trabajar solo con los datos de la planilla.\n\n¬øEst√°s seguro?')) {
            return;
        }

        if (!confirm('‚ö†Ô∏è CONFIRMACI√ìN FINAL\n\n¬øRealmente quer√©s vaciar el dashboard?\n\nEsta acci√≥n NO se puede deshacer.')) {
            return;
        }

        showLoader(true, 'Vaciando dashboard...');

        // Limpiar APP_DATA
        APP_DATA.length = 0;

        // Guardar en storage (vac√≠o)
        await saveDataToStorage();

        // Limpiar tambi√©n window.storage si existe
        try {
            if (window.storage) {
                await window.storage.delete('palletpro_data');
            }
        } catch(e) {
            console.log('No se pudo limpiar window.storage:', e);
        }

        showLoader(false);
        showSuccess('‚úÖ Dashboard vaciado correctamente\n\nAhora pod√©s usar "RECARGAR DESDE SHEETS" para cargar solo los datos de la planilla.');

        // Limpiar solapa CERRAR
        document.getElementById('c-desvio').value = '';
        document.getElementById('c-info-container').style.display = 'none';
        
        // Refrescar estad√≠sticas (mostrar√° vac√≠o)
        renderStats();
        
        // Refrescar historial
        const activeTab = document.querySelector('.nav-btn.active');
        if (activeTab && activeTab.id === 'tab-btn-historial') {
            renderHistorial();
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EXPORTAR EXCEL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function mostrarOpcionesExcel() {
        if (APP_DATA.length === 0) { alert('No hay datos para exportar'); return; }
        document.getElementById('excel-opciones-modal').style.display = 'flex';
    }

    function exportarExcel(filtro = 'todos') {
        document.getElementById('excel-opciones-modal').style.display = 'none';
        const fuente = filtro === 'abiertos'
            ? APP_DATA.filter(d => d.status !== 'CERRADO')
            : APP_DATA;
        if (fuente.length === 0) { alert('No hay datos para exportar con ese filtro'); return; }

        const dataToExport = fuente.map((d, i) => ({
            'N¬∞ DESVIO': d.nDesvio || (i + 1),
            'USUARIO QUE REPORTA': d.usuarioReporta,
            'FECHA/HORA': d.fechaReporte,
            'TURNO QUE OBSERVO DESVIO': d.turnoReporte,
            'NAVE': d.nave,
            'CALLE/CANAL': d.calle,
            'POSICION': d.posicion,
            'NIVEL': d.nivel,
            'FOTOGRAFIA DESVIO (RUTA DRIVE)': d.rutaFotoDesvio || d.nombreFotoDesvio || '‚Äî',
            'PALLET ROTO DETECTADO POR': d.detectadoPor,
            'ESTADO DEL PALLET': d.estadoPallet,
            'USUARIO QUE CIERRA': d.usuarioCierra || '',
            'FOTOGRAFIA CIERRE (RUTA DRIVE)': d.rutaFotoCierre || d.nombreFotoCierre || '',
            'PALLET ROTO CERRADO POR': d.cerradoPor || '',
            'TURNO QUE CERRO EL DESVIO': d.turnoCierre || '',
            'SE CORRIGIO EL DESVIO SI/NO': d.seCorrigio || (d.status === 'CERRADO' ? 'SI' : 'NO'),
            'FECHA/HORA CIERRE DEL DESVIO': d.fechaCierre || '',
            'CLIENTE/PROVEEDOR': d.cliente || ''
        }));

        // Generar hoja con UNA sola fila de header (sin la fila de grupos)
        const ws = XLSX.utils.json_to_sheet(dataToExport);

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'DATA');

        // Agregar hoja de usuarios
        const usersData = USERS_DB.map(u => ({ NOMBRE: u.nombre, CLAVE: u.clave, ROL: u.rol, ESTADO: 'ACTIVO' }));
        const wsUsers = XLSX.utils.json_to_sheet(usersData);
        XLSX.utils.book_append_sheet(wb, wsUsers, 'USUARIOS');

        const fecha = new Date().toLocaleDateString('es-AR').replace(/\//g, '-');
        const sufijo = filtro === 'abiertos' ? '_ABIERTOS' : '_COMPLETO';
        XLSX.writeFile(wb, `PalletPRO${sufijo}_${fecha}.xlsx`);
    }

    async function compartirExcel() {
        if (APP_DATA.length === 0) { alert('No hay datos para compartir'); return; }
        document.getElementById('share-modal').style.display = 'flex';
    }

    function cerrarModalCompartir() {
        document.getElementById('share-modal').style.display = 'none';
    }

    async function generarExcelBlob() {
        const fecha = new Date().toLocaleDateString('es-AR').replace(/\//g, '-');
        const dataToExport = APP_DATA.map((d, i) => ({
            'N¬∞ DESVIO': d.nDesvio || (i + 1),
            'USUARIO QUE REPORTA': d.usuarioReporta,
            'FECHA/HORA': d.fechaReporte,
            'TURNO QUE OBSERVO DESVIO': d.turnoReporte,
            'NAVE': d.nave,
            'CALLE/CANAL': d.calle,
            'POSICION': d.posicion,
            'NIVEL': d.nivel,
            'FOTOGRAFIA DESVIO (RUTA DRIVE)': d.rutaFotoDesvio || d.nombreFotoDesvio || '‚Äî',
            'PALLET ROTO DETECTADO POR': d.detectadoPor,
            'ESTADO DEL PALLET': d.estadoPallet,
            'USUARIO QUE CIERRA': d.usuarioCierra || '',
            'FOTOGRAFIA CIERRE (RUTA DRIVE)': d.rutaFotoCierre || d.nombreFotoCierre || '',
            'PALLET ROTO CERRADO POR': d.cerradoPor || '',
            'TURNO QUE CERRO EL DESVIO': d.turnoCierre || '',
            'SE CORRIGIO EL DESVIO SI/NO': d.seCorrigio || (d.status === 'CERRADO' ? 'SI' : 'NO'),
            'FECHA/HORA CIERRE DEL DESVIO': d.fechaCierre || '',
            'CLIENTE/PROVEEDOR': d.cliente || ''
        }));

        // Generar hoja con UNA sola fila de header (sin la fila de grupos)
        const ws = XLSX.utils.json_to_sheet(dataToExport);

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'DATA');
        
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        return {
            blob: new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }),
            filename: `PalletPRO_${fecha}.xlsx`,
            fecha: fecha
        };
    }

    function calcularEstadisticas(datos) {
        const ahora = new Date();
        const mesActual = ahora.getMonth();
        const anioActual = ahora.getFullYear();

        const datosMes = datos.filter(d => {
            const f = new Date(d.fechaReporteISO || d.fechaReporte);
            return f.getMonth() === mesActual && f.getFullYear() === anioActual;
        });

        function stats(arr) {
            const total    = arr.length;
            const abiertos = arr.filter(d => d.status === 'ABIERTO').length;
            const cerrados = arr.filter(d => d.status === 'CERRADO').length;
            const tasa     = total > 0 ? ((cerrados / total) * 100).toFixed(1) : 0;
            let totalHoras = 0, countH = 0;
            arr.filter(d => d.status === 'CERRADO' && d.fechaCierreISO).forEach(d => {
                const h = (new Date(d.fechaCierreISO) - new Date(d.fechaReporteISO)) / 3600000;
                if (h >= 0) { totalHoras += h; countH++; }
            });
            const promedio = countH > 0 ? (totalHoras / countH).toFixed(1) : 0;
            const criticos = arr.filter(d => {
                if (d.status === 'CERRADO') return false;
                return (ahora - new Date(d.fechaReporteISO || d.fechaReporte)) > 24*3600*1000;
            }).length;
            const naves = {};
            arr.forEach(d => {
                if (!naves[d.nave]) naves[d.nave] = { abiertos: 0, cerrados: 0 };
                d.status === 'CERRADO' ? naves[d.nave].cerrados++ : naves[d.nave].abiertos++;
            });
            const navesLineas = Object.entries(naves)
                .sort((a,b) => (b[1].abiertos+b[1].cerrados)-(a[1].abiertos+a[1].cerrados))
                .map(([n,v]) => `   ‚Ä¢ Nave ${n}: ${v.abiertos} ab / ${v.cerrados} cerr`).join('\n') || '   (sin datos)';
            const estados = {};
            arr.forEach(d => { estados[d.estadoPallet] = (estados[d.estadoPallet]||0)+1; });
            const topEstados = Object.entries(estados)
                .sort((a,b)=>b[1]-a[1]).slice(0,3)
                .map(([e,n]) => `   ‚Ä¢ ${e}: ${n}`).join('\n') || '   (sin datos)';
            return { total, abiertos, cerrados, tasa, promedio, criticos, navesLineas, topEstados };
        }

        return { mes: stats(datosMes), anio: stats(datos) };
    }

    async function compartirPorWhatsApp() {
        const excel = await generarExcelBlob();
        const { mes, anio } = calcularEstadisticas(APP_DATA);
        const ahora = new Date();
        const nombreMes = ahora.toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });

        const texto = `üìä *RESUMEN EJECUTIVO - PalletPRO*
üè≠ *CD Esteban Echeverr√≠a*
üìÖ Generado: ${excel.fecha}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìÜ *MES ACTUAL ‚Äî ${nombreMes.toUpperCase()}*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Total: ${mes.total} | ‚ö†Ô∏è Abiertos: ${mes.abiertos} | ‚úÖ Cerrados: ${mes.cerrados}
‚Ä¢ Tasa de cierre: ${mes.tasa}%
‚Ä¢ Tiempo promedio: ${mes.promedio}h
‚Ä¢ üî¥ Cr√≠ticos (+24hs): ${mes.criticos}

üèóÔ∏è Por nave:
${mes.navesLineas}

‚ö†Ô∏è Top estados:
${mes.topEstados}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìÖ *ACUMULADO ANUAL ${ahora.getFullYear()}*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Total: ${anio.total} | ‚ö†Ô∏è Abiertos: ${anio.abiertos} | ‚úÖ Cerrados: ${anio.cerrados}
‚Ä¢ Tasa de cierre: ${anio.tasa}%
‚Ä¢ Tiempo promedio: ${anio.promedio}h
‚Ä¢ üî¥ Cr√≠ticos (+24hs): ${anio.criticos}

üèóÔ∏è Por nave:
${anio.navesLineas}

üìé Ver detalle en el Excel adjunto.`;
        
        // Descargar Excel
        const url = URL.createObjectURL(excel.blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = excel.filename;
        a.click();
        
        // Abrir WhatsApp
        setTimeout(() => {
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(texto)}`;
            window.open(whatsappUrl, '_blank');
        }, 500);
        
        cerrarModalCompartir();
    }

    async function compartirPorEmail() {
        const excel = await generarExcelBlob();
        const { mes, anio } = calcularEstadisticas(APP_DATA);
        const ahora = new Date();
        const nombreMes = ahora.toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });

        const subject = `Reporte PalletPRO - ${excel.fecha}`;
        const body = `RESUMEN EJECUTIVO - PalletPRO
CD Esteban Echeverria
Generado: ${excel.fecha}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
MES ACTUAL ‚Äî ${nombreMes.toUpperCase()}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Total           : ${mes.total}
Abiertos        : ${mes.abiertos}
Cerrados        : ${mes.cerrados}
Tasa de cierre  : ${mes.tasa}%
Tiempo promedio : ${mes.promedio}h
Criticos +24hs  : ${mes.criticos}

Desvios por nave:
${mes.navesLineas.replace(/‚Ä¢ /g, '- ')}

Top estados:
${mes.topEstados.replace(/‚Ä¢ /g, '- ')}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ACUMULADO ANUAL ${ahora.getFullYear()}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Total           : ${anio.total}
Abiertos        : ${anio.abiertos}
Cerrados        : ${anio.cerrados}
Tasa de cierre  : ${anio.tasa}%
Tiempo promedio : ${anio.promedio}h
Criticos +24hs  : ${anio.criticos}

Desvios por nave:
${anio.navesLineas.replace(/‚Ä¢ /g, '- ')}

Top estados:
${anio.topEstados.replace(/‚Ä¢ /g, '- ')}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Archivo: ${excel.filename}
Ver detalle completo en el Excel adjunto.`;
        
        // Descargar Excel
        const url = URL.createObjectURL(excel.blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = excel.filename;
        a.click();
        
        // Abrir cliente de email
        setTimeout(() => {
            const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoUrl;
        }, 500);
        
        cerrarModalCompartir();
    }

    async function compartirExcel_OLD() {
        if (APP_DATA.length === 0) { alert('No hay datos para compartir'); return; }

        const fecha = new Date().toLocaleDateString('es-AR').replace(/\//g, '-');
        const fileName = `PalletPRO_${fecha}.xlsx`;

        // Generar el archivo Excel en memoria
        const dataToExport = APP_DATA.map((d, i) => ({
            'N¬∞ DESVIO': d.nDesvio || (i + 1),
            'USUARIO QUE REPORTA': d.usuarioReporta,
            'FECHA/HORA': d.fechaReporte,
            'TURNO QUE OBSERVO DESVIO': d.turnoReporte,
            'NAVE': d.nave,
            'CALLE/CANAL': d.calle,
            'POSICION': d.posicion,
            'NIVEL': d.nivel,
            'FOTOGRAFIA DESVIO (RUTA DRIVE)': d.rutaFotoDesvio || d.nombreFotoDesvio || '‚Äî',
            'PALLET ROTO DETECTADO POR': d.detectadoPor,
            'ESTADO DEL PALLET': d.estadoPallet,
            'USUARIO QUE CIERRA': d.usuarioCierra || '',
            'FOTOGRAFIA CIERRE (RUTA DRIVE)': d.rutaFotoCierre || d.nombreFotoCierre || '',
            'PALLET ROTO CERRADO POR': d.cerradoPor || '',
            'TURNO QUE CERRO EL DESVIO': d.turnoCierre || '',
            'SE CORRIGIO EL DESVIO SI/NO': d.seCorrigio || (d.status === 'CERRADO' ? 'SI' : 'NO'),
            'FECHA/HORA CIERRE DEL DESVIO': d.fechaCierre || '',
            'CLIENTE/PROVEEDOR': d.cliente || ''
        }));

        const ws = XLSX.utils.json_to_sheet(dataToExport, { origin: 'A2' });
        XLSX.utils.sheet_add_aoa(ws, [
            ['DESVIO DETECTADO','','','','','','','','','','','DESVIO CERRADO','','','','','','']
        ], { origin: 'A1' });

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'DATA');

        // Web Share API para compartir archivo
        if (navigator.share && navigator.canShare) {
            try {
                // Generar blob del Excel
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const file = new File([blob], fileName, { type: blob.type });

                if (navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: 'PalletPRO - Reporte de Desv√≠os',
                        text: `Reporte de desv√≠os CD Esteban Echeverr√≠a - ${fecha}`,
                        files: [file]
                    });
                } else {
                    // Fallback a compartir por URL en lugar de archivo
                    mostrarOpcionesCompartir(fileName);
                }
            } catch(err) {
                if (err.name !== 'AbortError') {
                    mostrarOpcionesCompartir(fileName);
                }
            }
        } else {
            mostrarOpcionesCompartir(fileName);
        }
    }

    function mostrarOpcionesCompartir(fileName) {
        const totalDesvios = APP_DATA.length;
        const pendientes = APP_DATA.filter(d => d.status === 'ABIERTO').length;
        const cerrados = APP_DATA.filter(d => d.status === 'CERRADO').length;
        const fecha = new Date().toLocaleDateString('es-AR');

        const mensaje = `üìä *PalletPRO - Reporte de Desv√≠os*
üìÖ Fecha: ${fecha}
üè≠ CD Esteban Echeverr√≠a

üìã Total desv√≠os: ${totalDesvios}
üî¥ Pendientes: ${pendientes}
üü¢ Cerrados: ${cerrados}

Descarg√° el archivo Excel adjunto para ver el detalle completo.`;

        const mensajeEncoded = encodeURIComponent(mensaje);
        
        const whatsappUrl = `https://wa.me/?text=${mensajeEncoded}`;
        const mailSubject = encodeURIComponent('PalletPRO - Reporte de Desv√≠os');
        const mailBody = encodeURIComponent(mensaje);
        const mailUrl = `mailto:?subject=${mailSubject}&body=${mailBody}`;

        if (confirm('No se puede compartir el archivo directamente desde este navegador.\n\n¬øDeseas descargar el Excel y luego compartir el mensaje por WhatsApp o Email?\n\nOK = Descargar Excel\nCancelar = Volver')) {
            exportarExcel();
            setTimeout(() => {
                if (confirm('Excel descargado.\n\n¬øCompartir mensaje por WhatsApp?')) {
                    window.open(whatsappUrl, '_blank');
                } else if (confirm('¬øCompartir por Email?')) {
                    window.open(mailUrl, '_blank');
                }
            }, 500);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UTILIDADES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function generateNumericId() {
        const existing = APP_DATA.filter(d => d.nDesvio && String(d.nDesvio).startsWith('CDEE-'));
        let maxNum = 0;
        
        existing.forEach(d => {
            const match = String(d.nDesvio).match(/CDEE-(\d+)/);
            if (match) {
                const num = parseInt(match[1]);
                if (num > maxNum) maxNum = num;
            }
        });
        
        const nextNum = maxNum + 1;
        return 'CDEE-' + String(nextNum).padStart(8, '0');
    }

    function showLoader(show, text = '') {
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        loader.style.display = show ? 'flex' : 'none';
        if (text) loaderText.textContent = text;
    }

    function showSuccess(msg = 'Operaci√≥n completada correctamente') {
        const overlay = document.getElementById('success-overlay');
        document.getElementById('success-msg').textContent = msg;
        overlay.style.display = 'flex';
        setTimeout(() => {
            overlay.style.display = 'none';
            renderHistorial();
            cargarDesviosPendientes();
        }, 2500);
    }

    function showAlert(msg) {
        // Vibraci√≥n en m√≥vil
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        alert('‚ö†Ô∏è ' + msg);
    }

    // Enter en campos
    document.getElementById('c-pin-cierra').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') guardarCierreDesvio();
    });

    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // REGISTRO DEL SERVICE WORKER (PWA)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let _swRegistration = null;

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
            try {
                const reg = await navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' });
                _swRegistration = reg;
                reg.update();

                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            mostrarBannerActualizacion();
                        }
                    });
                });

                if (reg.waiting) mostrarBannerActualizacion();

                console.log('[PWA] Service Worker registrado OK');
            } catch(err) {
                console.warn('[PWA] Error registrando Service Worker:', err);
            }
        });

        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (_swUpdating) window.location.reload();
        });
    }

    let _swUpdating = false;

    function mostrarBannerActualizacion() {
        const banner = document.getElementById('pwa-update-banner');
        if (banner) banner.style.display = 'flex';
    }

    function activarActualizacion() {
        _swUpdating = true;
        const banner = document.getElementById('pwa-update-banner');
        if (banner) {
            banner.innerHTML = '<span style="color:#F1F5F9;font-size:13px;font-weight:700;width:100%;text-align:center;">‚è≥ Actualizando... la app se va a recargar</span>';
        }
        if (_swRegistration && _swRegistration.waiting) {
            _swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
        } else {
            window.location.reload();
        }
    }

    </script>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GOOGLE APPS SCRIPT INSTRUCTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!--
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë                 INSTRUCCIONES - GOOGLE APPS SCRIPT (GAS)                   ‚ïë
    ‚ïë                   Para sincronizaci√≥n con Google Sheets y Drive             ‚ïë
    ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
    ‚ïë                                                                               ‚ïë
    ‚ïë  1. Abrir: https://script.google.com/                                         ‚ïë
    ‚ïë  2. Nuevo proyecto ‚Üí pegar el siguiente c√≥digo:                               ‚ïë
    ‚ïë                                                                               ‚ïë
    ‚ïë  const SHEET_ID = "1td9Llz1dewlm8iolw9CLpe2Ntr6fOm24hh2H5-PcRpU";          ‚ïë
    ‚ïë  const DRIVE_FOLDER_ROOT = "PalletPRO_Fotos";                                ‚ïë
    ‚ïë                                                                               ‚ïë
    ‚ïë  function doPost(e) {                                                         ‚ïë
    ‚ïë    try {                                                                       ‚ïë
    ‚ïë      const data = JSON.parse(e.postData.contents);                            ‚ïë
    ‚ïë      const ss = SpreadsheetApp.openById(SHEET_ID);                            ‚ïë
    ‚ïë      const sheet = ss.getSheetByName("DATA");                                 ‚ïë
    ‚ïë                                                                               ‚ïë
    ‚ïë      if (data.accion === "NUEVO_DESVIO") {                                    ‚ïë
    ‚ïë        // Buscar o crear carpeta ra√≠z en Drive                                ‚ïë
    ‚ïë        const rootFolder = getOrCreateFolder(null, DRIVE_FOLDER_ROOT);         ‚ïë
    ‚ïë        const naveFolder = getOrCreateFolder(rootFolder, "NAVE_" + data.nave); ‚ïë
    ‚ïë        // Guardar foto en Drive                                                ‚ïë
    ‚ïë        if (data.fotoBase64) {                                                  ‚ïë
    ‚ïë          const blob = Utilities.newBlob(                                       ‚ïë
    ‚ïë            Utilities.base64Decode(data.fotoBase64.split(',')[1]),             ‚ïë
    ‚ïë            'image/jpeg', data.nombreFoto);                                     ‚ïë
    ‚ïë          naveFolder.createFile(blob);                                          ‚ïë
    ‚ïë        }                                                                       ‚ïë
    ‚ïë        // Agregar fila a Sheets (sin foto, solo ruta)                         ‚ïë
    ‚ïë        sheet.appendRow([                                                       ‚ïë
    ‚ïë          data.nDesvio, data.usuarioReporta, data.fechaReporte,               ‚ïë
    ‚ïë          data.turnoReporte, data.nave, data.calle, data.posicion,             ‚ïë
    ‚ïë          data.nivel, data.rutaFoto, data.detectadoPor, data.estadoPallet,    ‚ïë
    ‚ïë          '', '', '', '', '', '', ''                                            ‚ïë
    ‚ïë        ]);                                                                     ‚ïë
    ‚ïë      }                                                                         ‚ïë
    ‚ïë                                                                               ‚ïë
    ‚ïë      if (data.accion === "CIERRE_DESVIO") {                                   ‚ïë
    ‚ïë        // Buscar fila del desv√≠o y actualizar columnas de cierre              ‚ïë
    ‚ïë        const rootFolder = getOrCreateFolder(null, DRIVE_FOLDER_ROOT);         ‚ïë
    ‚ïë        const naveFolder = getOrCreateFolder(rootFolder, "NAVE_" + ...);       ‚ïë
    ‚ïë        if (data.fotoCierreBase64) { /* guardar foto cierre */ }               ‚ïë
    ‚ïë        // Actualizar fila: columns L-R                                        ‚ïë
    ‚ïë        const rows = sheet.getDataRange().getValues();                          ‚ïë
    ‚ïë        for (let i = 2; i < rows.length; i++) {                                ‚ïë
    ‚ïë          if (rows[i][0] == data.nDesvio) {                                    ‚ïë
    ‚ïë            sheet.getRange(i+1,12,1,7).setValues([[                            ‚ïë
    ‚ïë              data.usuarioCierra, data.rutaFotoCierre, data.cerradoPor,         ‚ïë
    ‚ïë              data.turnoCierre, data.seCorrigio, data.fechaCierre,              ‚ïë
    ‚ïë              data.cliente                                                      ‚ïë
    ‚ïë            ]]);                                                                ‚ïë
    ‚ïë            break;                                                              ‚ïë
    ‚ïë          }                                                                     ‚ïë
    ‚ïë        }                                                                       ‚ïë
    ‚ïë      }                                                                         ‚ïë
    ‚ïë                                                                               ‚ïë
    ‚ïë      return ContentService.createTextOutput(JSON.stringify({ok:true}))        ‚ïë
    ‚ïë             .setMimeType(ContentService.MimeType.JSON);                       ‚ïë
    ‚ïë    } catch(err) {                                                              ‚ïë
    ‚ïë      return ContentService.createTextOutput(JSON.stringify({error:err}))      ‚ïë
    ‚ïë             .setMimeType(ContentService.MimeType.JSON);                       ‚ïë
    ‚ïë    }                                                                           ‚ïë
    ‚ïë  }                                                                             ‚ïë
    ‚ïë                                                                               ‚ïë
    ‚ïë  function getOrCreateFolder(parent, name) {                                   ‚ïë
    ‚ïë    const root = parent || DriveApp;                                            ‚ïë
    ‚ïë    const folders = root.getFoldersByName(name);                                ‚ïë
    ‚ïë    return folders.hasNext() ? folders.next() : root.createFolder(name);       ‚ïë
    ‚ïë  }                                                                             ‚ïë
    ‚ïë                                                                               ‚ïë
    ‚ïë  3. Desplegar ‚Üí "Nueva implementaci√≥n" ‚Üí Tipo: App Web                        ‚ïë
    ‚ïë     Ejecutar como: Yo / Acceso: Cualquier usuario                             ‚ïë
    ‚ïë  4. Copiar URL generada y reemplazar CONFIG.gasUrl en esta app                ‚ïë
    ‚ïë                                                                               ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    -->

    <!-- MODAL EDITAR DESV√çO -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-black text-slate-800">‚úèÔ∏è EDITAR DESV√çO</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="label">Nave</label>
                        <select id="edit-nave" class="input-field">
                            <option value="A">Nave A</option>
                            <option value="B">Nave B</option>
                            <option value="C">Nave C</option>
                            <option value="D">Nave D</option>
                            <option value="D-S">Nave D-S</option>
                            <option value="E">Nave E</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Calle/Canal</label>
                        <input type="text" id="edit-calle" class="input-field">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="label">Posici√≥n</label>
                        <input type="text" id="edit-posicion" class="input-field">
                    </div>
                    <div>
                        <label class="label">Nivel</label>
                        <input type="text" id="edit-nivel" class="input-field">
                    </div>
                </div>
                
                <div>
                    <label class="label">Estado del Pallet</label>
                    <select id="edit-estado" class="input-field">
                        <option value="ROTO">PALLET ROTO</option>
                        <option value="DA√ëADO">PALLET DA√ëADO</option>
                        <option value="SUCIO">PALLET SUCIO</option>
                        <option value="CONTAMINADO">PALLET CONTAMINADO</option>
                    </select>
                </div>
                
                <div>
                    <label class="label">Detectado Por</label>
                    <select id="edit-detectado" class="input-field">
                        <option value="RECEPCI√ìN">RECEPCI√ìN</option>
                        <option value="PREPARACI√ìN">PREPARACI√ìN</option>
                        <option value="EXPEDICI√ìN">EXPEDICI√ìN</option>
                        <option value="HIGIENE Y SEGURIDAD">HIGIENE Y SEGURIDAD</option>
                    </select>
                </div>
            </div>
            
            <div class="flex gap-2 mt-6">
                <button onclick="closeEditModal()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-bold">
                    CANCELAR
                </button>
                <button onclick="guardarEdicion()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">
                    GUARDAR
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Compartir Excel -->
    <div id="share-modal" class="overlay" style="display: none; z-index: 200;">
        <div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 900; text-align: center;">
                üì§ COMPARTIR REPORTE
            </h3>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="compartirPorWhatsApp()" style="width: 100%; background: #25D366; color: white; padding: 16px 24px; border: none; border-radius: 12px; font-weight: 900; font-size: 16px; display: flex; align-items: center; justify-center; gap: 12px; cursor: pointer; border-bottom: 4px solid #1DA851;">
                    <i class="fa-brands fa-whatsapp" style="font-size: 24px;"></i>
                    WhatsApp
                </button>
                
                <button onclick="compartirPorEmail()" style="width: 100%; background: #3B82F6; color: white; padding: 16px 24px; border: none; border-radius: 12px; font-weight: 900; font-size: 16px; display: flex; align-items: center; justify-center; gap: 12px; cursor: pointer; border-bottom: 4px solid #1E40AF;">
                    <i class="fa-solid fa-envelope" style="font-size: 20px;"></i>
                    Email
                </button>
                
                <button onclick="cerrarModalCompartir()" style="width: 100%; background: #CBD5E1; color: #475569; padding: 12px 24px; border: none; border-radius: 12px; font-weight: 900; cursor: pointer;">
                    Cancelar
                </button>
            </div>
        </div>
    </div>


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         MODAL SELECTOR: C√ÅMARA O GALER√çA
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="modal-foto-selector" style="display:none; position:fixed; inset:0; z-index:500;
         background:rgba(0,0,0,0.65); align-items:flex-end; justify-content:center;">
        <div style="background:#1e293b; border-radius:20px 20px 0 0; padding:24px 20px 36px;
                    width:100%; max-width:480px; box-shadow:0 -8px 40px rgba(0,0,0,0.4);">
            <p style="text-align:center; color:#64748b; font-size:12px; font-weight:700;
                      letter-spacing:1.5px; margin-bottom:18px;">SELECCIONAR FOTO</p>
            <button id="modal-btn-camara" type="button" style="
                display:flex; align-items:center; gap:16px; width:100%;
                background:#0f172a; border:none; border-radius:14px;
                padding:18px 20px; margin-bottom:10px; cursor:pointer; color:#f1f5f9; text-align:left;">
                <span style="font-size:26px;">üì∑</span>
                <span style="font-size:15px; font-weight:800; letter-spacing:0.5px;">SACAR FOTO</span>
            </button>
            <button id="modal-btn-galeria" type="button" style="
                display:flex; align-items:center; gap:16px; width:100%;
                background:#0f172a; border:none; border-radius:14px;
                padding:18px 20px; margin-bottom:18px; cursor:pointer; color:#f1f5f9; text-align:left;">
                <span style="font-size:26px;">üñºÔ∏è</span>
                <span style="font-size:15px; font-weight:800; letter-spacing:0.5px;">ELEGIR DE GALER√çA</span>
            </button>
            <button onclick="cerrarModalFoto()" type="button" style="
                width:100%; background:#334155; border:none; border-radius:14px;
                padding:15px; cursor:pointer; color:#64748b; font-size:14px; font-weight:700;">
                CANCELAR
            </button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         MODAL EDITOR DE IMAGEN (solo Nuevo Desv√≠o)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="modal-editor-foto" style="display:none; position:fixed; inset:0; z-index:600;
         background:#0f172a; flex-direction:column; align-items:center; justify-content:flex-start;">

        <!-- Header -->
        <div style="width:100%; max-width:600px; display:flex; align-items:center;
                    justify-content:space-between; padding:12px 16px;
                    background:#1e293b; border-bottom:1px solid #334155; flex-shrink:0;">
            <span style="color:#f1f5f9; font-weight:800; font-size:15px;">‚úèÔ∏è MARCAR DESV√çO</span>
            <span style="color:#64748b; font-size:12px;">Dibuj√° encima de la foto</span>
        </div>

        <!-- Toolbar -->
        <div style="width:100%; max-width:600px; display:flex; align-items:center; gap:8px;
                    padding:10px 12px; background:#1e293b; flex-shrink:0; flex-wrap:wrap;">
            <button id="editor-tool-circle" onclick="setEditorTool('circle')" type="button"
                style="padding:8px 14px; border-radius:10px; border:2px solid #ef4444;
                       background:#ef4444; color:#fff; font-size:13px; font-weight:800; cursor:pointer;">
                ‚≠ï C√≠rculo
            </button>
            <button id="editor-tool-arrow" onclick="setEditorTool('arrow')" type="button"
                style="padding:8px 14px; border-radius:10px; border:2px solid #475569;
                       background:#334155; color:#94a3b8; font-size:13px; font-weight:800; cursor:pointer;">
                ‚û°Ô∏è Flecha
            </button>
            <button id="editor-tool-pen" onclick="setEditorTool('pen')" type="button"
                style="padding:8px 14px; border-radius:10px; border:2px solid #475569;
                       background:#334155; color:#94a3b8; font-size:13px; font-weight:800; cursor:pointer;">
                ‚úèÔ∏è Libre
            </button>
            <div style="flex:1"></div>
            <button onclick="editorUndo()" type="button"
                style="padding:8px 14px; border-radius:10px; border:2px solid #475569;
                       background:#334155; color:#f59e0b; font-size:13px; font-weight:800; cursor:pointer;">
                ‚Ü© Deshacer
            </button>
            <button onclick="editorClear()" type="button"
                style="padding:8px 14px; border-radius:10px; border:2px solid #475569;
                       background:#334155; color:#94a3b8; font-size:13px; font-weight:800; cursor:pointer;">
                üóë Limpiar
            </button>
        </div>

        <!-- Canvas -->
        <div style="flex:1; width:100%; max-width:600px; overflow:auto;
                    display:flex; align-items:center; justify-content:center; padding:8px;">
            <canvas id="editor-canvas"
                style="touch-action:none; cursor:crosshair; max-width:100%;
                       border-radius:10px; box-shadow:0 4px 24px rgba(0,0,0,0.6);">
            </canvas>
        </div>

        <!-- Footer -->
        <div style="width:100%; max-width:600px; display:flex; gap:10px;
                    padding:12px 16px 30px; background:#1e293b;
                    border-top:1px solid #334155; flex-shrink:0;">
            <button onclick="cancelarEditorFoto()" type="button"
                style="flex:1; padding:15px; border-radius:14px; border:none;
                       background:#334155; color:#64748b; font-size:14px; font-weight:700; cursor:pointer;">
                CANCELAR
            </button>
            <button onclick="confirmarEditorFoto()" type="button"
                style="flex:2; padding:15px; border-radius:14px; border:none;
                       background:#22c55e; color:#fff; font-size:15px; font-weight:800;
                       cursor:pointer; letter-spacing:0.5px;">
                ‚úÖ CONFIRMAR FOTO
            </button>
        </div>
    </div>


    <!-- ‚ïê‚ïê BANNER ACTUALIZACI√ìN PWA ‚ïê‚ïê -->
    <div id="pwa-update-banner" style="
        display:none; position:fixed; bottom:0; left:0; right:0; z-index:9999;
        background:#0F172A; border-top:3px solid #FF8C00;
        padding:14px 18px; align-items:center; justify-content:space-between; gap:12px;">
        <span style="color:#F1F5F9; font-size:13px; font-weight:700; flex:1;">
            üöÄ <strong style="color:#FB923C;">Nueva versi√≥n disponible.</strong> Actualiz√° para tener los √∫ltimos cambios.
        </span>
        <button onclick="activarActualizacion()" style="
            background:#FF8C00; color:#0F172A; border:none; border-radius:10px;
            padding:10px 18px; font-weight:900; font-size:13px; cursor:pointer; white-space:nowrap;">
            ACTUALIZAR AHORA
        </button>
        <button onclick="document.getElementById('pwa-update-banner').style.display='none'" style="
            background:transparent; color:#64748B; border:none; font-size:20px; cursor:pointer; padding:4px;">
            ‚úï
        </button>
    </div>


    <!-- ‚ïê‚ïê MODAL OPCIONES EXCEL ‚ïê‚ïê -->
    <div id="excel-opciones-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:300; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:16px; padding:24px; margin:20px; width:100%; max-width:340px; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="font-size:17px; font-weight:900; color:#0F172A; margin:0 0 6px 0;">üìä Exportar Excel</h3>
            <p style="font-size:13px; color:#64748B; margin:0 0 20px 0;">¬øQu√© datos quer√©s exportar?</p>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button onclick="exportarExcel('todos')" style="background:#0F172A; color:white; border:none; border-radius:10px; padding:14px; font-weight:900; font-size:14px; cursor:pointer;">
                    üìã PLANILLA COMPLETA<br><span style="font-size:11px; font-weight:400; opacity:0.7;">Todos los desv√≠os (abiertos y cerrados)</span>
                </button>
                <button onclick="exportarExcel('abiertos')" style="background:#FF8C00; color:white; border:none; border-radius:10px; padding:14px; font-weight:900; font-size:14px; cursor:pointer;">
                    ‚ö†Ô∏è SOLO ABIERTOS<br><span style="font-size:11px; font-weight:400; opacity:0.7;">√önicamente desv√≠os pendientes de cierre</span>
                </button>
                <button onclick="document.getElementById('excel-opciones-modal').style.display='none'" style="background:#F1F5F9; color:#475569; border:none; border-radius:10px; padding:12px; font-weight:700; font-size:13px; cursor:pointer;">
                    CANCELAR
                </button>
            </div>
        </div>
    </div>

</body>
</html>
